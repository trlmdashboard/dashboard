<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHG Loan Progress Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 20px;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        .header-logos {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
        }
        .header-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .summary-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .summary-card {
            flex: 1;
            min-width: 300px;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }
        .card-header {
            padding: 15px 20px;
            color: white;
            position: relative;
            z-index: 1;
        }
        .shg-card {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .shg-card .card-header {
            background: rgba(0, 0, 0, 0.15);
        }
        .shg-card .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .individual-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .individual-card .card-header {
            background: rgba(0, 0, 0, 0.15);
        }
        .individual-card .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .card-body {
            padding: 15px;
            position: relative;
            display: flex;
            align-items: center;
        }
        .progress-circle-container {
            flex: 0 0 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 20px;
        }
        .progress-circle {
            width: 80px;
            height: 80px;
            position: relative;
        }
        .progress-circle svg {
            width: 100%;
            height: 100%;
        }
        .progress-circle circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .progress-circle-bg {
            stroke: rgba(255, 255, 255, 0.2);
        }
        .shg-card .progress-circle-fill {
            stroke: white;
        }
        .individual-card .progress-circle-fill {
            stroke: white;
        }
        .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.6em;
            font-weight: bold;
            color: white;
        }
        .stats-container {
            flex: 1;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 5px;
            min-height: 1.5em;
            color: white;
        }
        .card-pattern {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            opacity: 0.1;
        }
        .shg-card .card-pattern {
            background: radial-gradient(circle, white 0%, transparent 70%);
        }
        .individual-card .card-pattern {
            background: radial-gradient(circle, white 0%, transparent 70%);
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            height: 220px;
        }
        .chart-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .data-table {
            font-size: 16px;
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .data-table th, .data-table td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: center;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: relative;
            color: #34495e;
            font-size: 0.95em;
        }
        .group-header {
            background-color: #e9ecef !important;
            font-weight: 700;
            text-align: center !important;
            font-size: 1em;
        }
        .data-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        .data-table tr:hover {
            background-color: #f1f7ff;
        }
        .district-row {
            cursor: pointer;
            font-weight: bold;
            background-color: #e6f0ff;
            font-size: 1.05em;
        }
        .block-row td:first-child {
            text-align: left;
            padding-left: 40px !important;
            font-size: 0.95em;
        }
        .summary-row {
            font-weight: 600;
            background-color: rgba(52, 152, 219, 0.1);
            font-size: 1.05em;
        }
        .recent-submission {
            font-size: 0.85em;
            background-color: #27ae60;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 3px;
            font-weight: 500;
        }
        .amount-cell {
            font-size: 0.95em;
            color: #7f8c8d;
        }
        .progress-thin {
            height: 6px;
            margin-bottom: 5px;
        }
        .progress-thin .progress-bar {
            border-radius: 3px;
        }
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .progress-container .progress {
            width: 100%;
        }
        .text-center {
            text-align: center;
        }
        .mt-1 {
            margin-top: 4px;
        }
        .last3-days {
            font-size: 0.85em;
            color: #27ae60;
            font-weight: 500;
            margin-top: 4px;
        }
        .no-progress {
            font-size: 0.85em;
            color: #95a5a6;
            font-style: italic;
            margin-top: 4px;
        }
        .last3-days-badge {
            background-color: #e8f5e9;
            color: #27ae60;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-block;
            margin-top: 3px;
        }
        .highlight-section {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .loading {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: transparent;
            position: relative;
            overflow: hidden;
            display: inline-block;
            min-width: 60px;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-circle.loading circle {
            stroke: rgba(255, 255, 255, 0.3);
        }
        .progress-value.loading {
            width: 50px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .btn-expand {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        .btn-expand:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            color: white;
        }
        .info-icon {
            color: #3498db;
            cursor: pointer;
            margin-left: 5px;
            font-size: 16px;
        }
        .info-icon:hover {
            color: #2980b9;
        }
        .modal-content {
            border-radius: 12px;
            overflow: hidden;
        }
        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-weight: 600;
        }
        .modal-body {
            padding: 20px;
        }
        .block-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .block-detail-table th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .block-detail-table td {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .block-detail-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .block-detail-table tr:hover {
            background-color: #e6f0ff;
        }
        .detail-chart-container {
            height: 250px;
            margin-top: 20px;
        }
        .block-summary-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: space-between;
        }
        .block-summary-section {
            flex: 1;
            min-width: 300px;
        }
        .section-header {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shg-header {
            color: #3498db;
            border-color: #3498db;
        }
        .individual-header {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        .block-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        .block-summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .block-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .shg-card-style {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .individual-card-style {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .block-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .block-summary-title {
            font-size: 0.85em;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.85);
        }
        .block-summary-card .block-summary-title {
            font-weight: 500;
        }
        .block-summary-value {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .shg-card-style .block-summary-value {
            color: white;
        }
        .individual-card-style .block-summary-value {
            color: white;
        }
        .block-summary-target {
            font-size: 0.8em;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        .achievement-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 5px;
        }
        .shg-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .individual-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .day-progress {
            width: 100%;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .day-progress-bar {
            height: 100%;
        }
        .shg-progress {
            background: rgba(255,255,255,0.6);
        }
        .individual-progress {
            background: rgba(255,255,255,0.6);
        }
        .achievement-line {
            border-top: 2px dashed #7f8c8d;
            position: relative;
            margin-top: 10px;
        }
        .achievement-line::after {
            content: 'Target Achievement';
            position: absolute;
            right: 0;
            top: -10px;
            background: white;
            padding: 0 5px;
            color: #7f8c8d;
            font-size: 12px;
        }
        .table-controls {
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .table-controls span {
            font-weight: 500;
            color: #495057;
        }
        #decrease-font, #reset-font, #increase-font {
            width: 40px;
        }
        .font-sm {
            font-size: 14px !important;
        }
        .font-md {
            font-size: 16px !important;
        }
        .font-lg {
            font-size: 18px !important;
        }
        .font-xl {
            font-size: 20px !important;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-logos">
            <img src="https://pbs.twimg.com/profile_images/1524416655140753408/yXqxucvR_400x400.jpg" class="header-logo" alt="Logo 1">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Tripura_Emblem.png/330px-Tripura_Emblem.png" class="header-logo" alt="Tripura Emblem">
        </div>
        <div class="container"><center>
            <h1><i class="bi bi-graph-up"></i> "SAMRIDDHI" CAMPAIGN - DASHBOARD</h1>
            <p class="mb-0">(Mahilader Arthik Khomotayoner Jonyo Ek Ononyo Podokhyep)</br>(1st August to 7th September, 2025)</p>
        </center></div>
    </div>

    <div class="container">
        <div class="summary-cards">
            <div class="summary-card shg-card">
                <div class="card-header">
                    <h4><i class="bi bi-people-fill"></i> SHG Loan Summary</h4>
                    <div class="card-pattern"></div>
                </div>
                <div class="card-body">
                    <div class="progress-circle-container">
                        <div class="progress-circle loading">
                            <svg viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
                                <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="shg-progress-circle"></circle>
                            </svg>
                            <div class="progress-value loading" id="shg-achievement-value"></div>
                        </div>
                    </div>
                    <div class="stats-container">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-target-value"></div>
                                <div class="stat-label">Target</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-submitted-value"></div>
                                <div class="stat-label">Submitted</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-sanctioned-value"></div>
                                <div class="stat-label">Sanctioned</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-approval-value"></div>
                                <div class="stat-label">Approval Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="summary-card individual-card">
                <div class="card-header">
                    <h4><i class="bi bi-person-fill"></i> Individual Loan Summary</h4>
                    <div class="card-pattern"></div>
                </div>
                <div class="card-body">
                    <div class="progress-circle-container">
                        <div class="progress-circle loading">
                            <svg viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
                                <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="individual-progress-circle"></circle>
                            </svg>
                            <div class="progress-value loading" id="individual-achievement-value"></div>
                        </div>
                    </div>
                    <div class="stats-container">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-target-value"></div>
                                <div class="stat-label">Target</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-submitted-value"></div>
                                <div class="stat-label">Submitted</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-sanctioned-value"></div>
                                <div class="stat-label">Sanctioned</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-approval-value"></div>
                                <div class="stat-label">Approval Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SHG Loan Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-people-fill" style="color: #3498db;"></i> SHG Loan - Daily Submitted vs Sanctioned
            </div>
            <canvas id="shgLoanChart"></canvas>
        </div>
        
        <!-- Individual Loan Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-person-fill" style="color: #e74c3c;"></i> Individual Loan - Daily Submitted vs Sanctioned
            </div>
            <canvas id="individualLoanChart"></canvas>
        </div>
        
        <button class="btn-expand" id="toggleAll">
            <i class="bi bi-arrows-angle-expand"></i> Expand/Collapse All Districts
        </button>
        
        <div class="table-controls mb-3 d-flex justify-content-end align-items-center" style="width:100%;">
            <span class="me-2">Table Font Size:</span>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="decrease-font" title="Decrease font size">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button class="btn btn-outline-secondary" id="reset-font" title="Reset to default">
                    <i class="bi bi-fonts"></i>
                </button>
                <button class="btn btn-outline-secondary" id="increase-font" title="Increase font size">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <table class="data-table" id="loanTable">
        <thead>
            <tr>
                <th rowspan="2">District / Block Name</th>
                <th colspan="7" class="group-header">SHG Loan</th>
                <th colspan="7" class="group-header">Individual Loan</th>
            </tr>
            <tr>
                <th>Target</th>
                <th>Target Amount (₹ Lakh)</th>
                <th>Submitted</th>
                <th>Submitted Amount (₹ Lakh)</th>
                <th>Sanctioned</th>
                <th>Sanctioned Amount (₹ Lakh)</th>
                <th>Achievement (%)</th>
                <th>Target</th>
                <th>Target Amount (₹ Lakh)</th>
                <th>Submitted</th>
                <th>Submitted Amount (₹ Lakh)</th>
                <th>Sanctioned</th>
                <th>Sanctioned Amount (₹ Lakh)</th>
                <th>Achievement (%)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Block Details Modal -->
    <div class="modal fade" id="blockDetailsModal" tabindex="-1" aria-labelledby="blockDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blockDetailsModalLabel">Block Details: <span id="blockNameTitle">Loading...</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="detail-chart-container">
                        <canvas id="blockDetailChart"></canvas>
                    </div>
                    
                    <!-- Enhanced Block Summary Cards -->
                    <div class="block-summary-container">
                        <div class="block-summary-section">
                            <div class="section-header shg-header">
                                <i class="bi bi-people-fill"></i> SHG Loan Summary
                            </div>
                            <div class="block-summary-grid" id="shg-summary-cards">
                                <!-- Cards will be inserted here by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="block-summary-section">
                            <div class="section-header individual-header">
                                <i class="bi bi-person-fill"></i> Individual Loan Summary
                            </div>
                            <div class="block-summary-grid" id="individual-summary-cards">
                                <!-- Cards will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4"><i class="bi bi-calendar-date"></i> Day-wise Progress</h5>
                    <div class="table-responsive">
                        <table class="block-detail-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>SHG Target</th>
                                    <th>SHG Submitted</th>
                                    <th>SHG Sanctioned</th>
                                    <th>Individual Target</th>
                                    <th>Individual Submitted</th>
                                    <th>Individual Sanctioned</th>
                                </tr>
                            </thead>
                            <tbody id="blockDetailBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Updated CSV URL
    const csvUrl = "https://docs.google.com/spreadsheets/d/1E-GGB71B_JViWKcKL7osFwav6GvMR2lAH8Taaucz7tM/gviz/tq?tqx=out:csv&sheet=jsondata";
    
    // District targets for both SHG and Individual loans
    const targets = {
        "DHALAI": { shg: { loan: 800, amount: 2504 }, individual: { loan: 135, amount: 270 } },
        "GOMATI": { shg: { loan: 850, amount: 2660.5 }, individual: { loan: 135, amount: 270 } },
        "KHOWAI": { shg: { loan: 500, amount: 1565 }, individual: { loan: 85, amount: 170 } },
        "NORTH TRIPURA": { shg: { loan: 510, amount: 1596.3 }, individual: { loan: 100, amount: 200 } },
        "SEPAHIJALA": { shg: { loan: 600, amount: 1878 }, individual: { loan: 85, amount: 170 } },
        "SOUTH TRIPURA": { shg: { loan: 750, amount: 2347.5 }, individual: { loan: 135, amount: 270 } },
        "UNAKOTI": { shg: { loan: 400, amount: 1252 }, individual: { loan: 70, amount: 140 } },
        "WEST TRIPURA": { shg: { loan: 840, amount: 2629.2 }, individual: { loan: 135, amount: 270 } }
    };

    // Block targets for both SHG and Individual loans
    const blockTargets = {
        "BC NAGAR": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "BOKAFA": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 18, amount: 36 } },
        "HRISHYAMUKH": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 19, amount: 38 } },
        "JOLAIBARI": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 23, amount: 46 } },
        "POANGBARI": { shg: { loan: 30, amount: 93.9 }, individual: { loan: 8, amount: 16 } },
        "RAJNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 19, amount: 38 } },
        "RUPAICHARI": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 11, amount: 22 } },
        "SATCHAND": { shg: { loan: 130, amount: 406.9 }, individual: { loan: 22, amount: 44 } },
        "DAMCHERRA": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 12, amount: 24 } },
        "DASDA": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 12, amount: 24 } },
        "JAMPUI HILLS": { shg: { loan: 15, amount: 46.95 }, individual: { loan: 6, amount: 12 } },
        "JUBARAJNAGAR": { shg: { loan: 90, amount: 281.7 }, individual: { loan: 15, amount: 30 } },
        "KADAMTALA": { shg: { loan: 100, amount: 313 }, individual: { loan: 15, amount: 30 } },
        "KALACHERRA": { shg: { loan: 70, amount: 219.1 }, individual: { loan: 15, amount: 30 } },
        "LALJURI": { shg: { loan: 60, amount: 187.8 }, individual: { loan: 10, amount: 20 } },
        "PANISAGAR": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 15, amount: 30 } },
        "CHANDIPUR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 12, amount: 24 } },
        "GOURNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 21, amount: 42 } },
        "KUMARGHAT": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 24, amount: 48 } },
        "PECHARTHAL": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 13, amount: 26 } },
        "SALEMA": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "AMBASSA": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 25, amount: 50 } },
        "CHAWMANU": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 14, amount: 28 } },
        "DUMBURNAGAR": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 21, amount: 42 } },
        "DURGACHOWMUHANI": { shg: { loan: 180, amount: 563.4 }, individual: { loan: 21, amount: 42 } },
        "GANGANAGAR": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 6, amount: 12 } },
        "MANU": { shg: { loan: 170, amount: 532.1 }, individual: { loan: 25, amount: 50 } },
        "RAISHYABARI": { shg: { loan: 35, amount: 109.55 }, individual: { loan: 8, amount: 16 } },
        "KALYANPUR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 14, amount: 28 } },
        "KHOWAI": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 18, amount: 36 } },
        "MUNGIAKAMI": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "PADMABIBA": { shg: { loan: 115, amount: 359.95 }, individual: { loan: 20, amount: 40 } },
        "TELIAMURA": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 18, amount: 36 } },
        "DHARMANAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 20, amount: 40 } },
        "DASHRATHCHAND": { shg: { loan: 60, amount: 187.8 }, individual: { loan: 12, amount: 24 } },
        "KADAMTALA": { shg: { loan: 70, amount: 219.1 }, individual: { loan: 15, amount: 30 } },
        "KANCHANPUR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 18, amount: 36 } },
        "KUMARGHAT": { shg: { loan: 70, amount: 219.1 }, individual: { loan: 15, amount: 30 } },
        "PECHARTHAL": { shg: { loan: 60, amount: 187.8 }, individual: { loan: 10, amount: 20 } },
        "BISHALGARH": { shg: { loan: 120, amount: 375.6 }, individual: { loan: 20, amount: 40 } },
        "BOXANAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 18, amount: 36 } },
        "CHARILAM": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 15, amount: 30 } },
        "MELAGHAR": { shg: { loan: 90, amount: 281.7 }, individual: { loan: 15, amount: 30 } },
        "MOHANPUR": { shg: { loan: 100, amount: 313 }, individual: { loan: 17, amount: 34 } },
        "BISHALGARH": { shg: { loan: 120, amount: 375.6 }, individual: { loan: 20, amount: 40 } },
        "BOXANAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 18, amount: 36 } },
        "CHARILAM": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 15, amount: 30 } },
        "MELAGHAR": { shg: { loan: 90, amount: 281.7 }, individual: { loan: 15, amount: 30 } },
        "MOHANPUR": { shg: { loan: 100, amount: 313 }, individual: { loan: 17, amount: 34 } },
        "BELONIA": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 25, amount: 50 } },
        "JOLAIBARI": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 23, amount: 46 } },
        "RAJNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 19, amount: 38 } },
        "SANTIRBAZAR": { shg: { loan: 180, amount: 563.4 }, individual: { loan: 30, amount: 60 } },
        "SABROOM": { shg: { loan: 195, amount: 610.35 }, individual: { loan: 38, amount: 76 } },
        "KARMA CHHARA": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 8, amount: 16 } },
        "KAKRABAN": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "KURSEONG": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 15, amount: 30 } },
        "MATABARI": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 20, amount: 40 } },
        "KATHALIA": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 15, amount: 30 } },
        "KILLA": { shg: { loan: 90, amount: 281.7 }, individual: { loan: 15, amount: 30 } },
        "GOURNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 21, amount: 42 } },
        "KUMARGHAT": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 24, amount: 48 } },
        "PECHARTHAL": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 13, amount: 26 } },
        "SALEMA": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } }
    };

    // Global variables
    let allData = [];
    let shgChart, individualChart, blockDetailChart;
    let currentFontSize = 16; // Default font size

    // Function to load and parse CSV data
    async function loadCSVData() {
        try {
            const response = await fetch(csvUrl);
            const csvData = await response.text();
            const rows = csvData.split('\n').slice(1); // Skip header row
            
            allData = rows.map(row => {
                const values = row.split(',');
                return {
                    district: values[0]?.trim() || '',
                    block: values[1]?.trim() || '',
                    date: values[2]?.trim() || '',
                    shgTarget: parseInt(values[3] || 0),
                    shgSubmitted: parseInt(values[4] || 0),
                    shgSanctioned: parseInt(values[5] || 0),
                    individualTarget: parseInt(values[6] || 0),
                    individualSubmitted: parseInt(values[7] || 0),
                    individualSanctioned: parseInt(values[8] || 0)
                };
            }).filter(row => row.district && row.block && row.date);
            
            processData(allData);
        } catch (error) {
            console.error('Error loading CSV data:', error);
            alert('Failed to load data. Please check your internet connection and try again.');
        }
    }

    // Function to process data and update the dashboard
    function processData(data) {
        // Calculate totals
        const totals = {
            shgTarget: 0,
            shgSubmitted: 0,
            shgSanctioned: 0,
            individualTarget: 0,
            individualSubmitted: 0,
            individualSanctioned: 0
        };
        
        // Group data by district and block
        const districtData = {};
        const blockData = {};
        
        data.forEach(row => {
            // Update totals
            totals.shgTarget += row.shgTarget;
            totals.shgSubmitted += row.shgSubmitted;
            totals.shgSanctioned += row.shgSanctioned;
            totals.individualTarget += row.individualTarget;
            totals.individualSubmitted += row.individualSubmitted;
            totals.individualSanctioned += row.individualSanctioned;
            
            // Group by district
            if (!districtData[row.district]) {
                districtData[row.district] = {
                    shgTarget: 0,
                    shgSubmitted: 0,
                    shgSanctioned: 0,
                    individualTarget: 0,
                    individualSubmitted: 0,
                    individualSanctioned: 0
                };
            }
            
            districtData[row.district].shgTarget += row.shgTarget;
            districtData[row.district].shgSubmitted += row.shgSubmitted;
            districtData[row.district].shgSanctioned += row.shgSanctioned;
            districtData[row.district].individualTarget += row.individualTarget;
            districtData[row.district].individualSubmitted += row.individualSubmitted;
            districtData[row.district].individualSanctioned += row.individualSanctioned;
            
            // Group by block
            const blockKey = `${row.district}-${row.block}`;
            if (!blockData[blockKey]) {
                blockData[blockKey] = {
                    district: row.district,
                    block: row.block,
                    shgTarget: 0,
                    shgSubmitted: 0,
                    shgSanctioned: 0,
                    individualTarget: 0,
                    individualSubmitted: 0,
                    individualSanctioned: 0,
                    dailyData: []
                };
            }
            
            blockData[blockKey].shgTarget += row.shgTarget;
            blockData[blockKey].shgSubmitted += row.shgSubmitted;
            blockData[blockKey].shgSanctioned += row.shgSanctioned;
            blockData[blockKey].individualTarget += row.individualTarget;
            blockData[blockKey].individualSubmitted += row.individualSubmitted;
            blockData[blockKey].individualSanctioned += row.individualSanctioned;
            
            // Add daily data
            blockData[blockKey].dailyData.push({
                date: row.date,
                shgTarget: row.shgTarget,
                shgSubmitted: row.shgSubmitted,
                shgSanctioned: row.shgSanctioned,
                individualTarget: row.individualTarget,
                individualSubmitted: row.individualSubmitted,
                individualSanctioned: row.individualSanctioned
            });
        });
        
        // Update summary cards
        updateSummaryCards(totals);
        
        // Update charts
        updateCharts(data);
        
        // Update table
        updateTable(districtData, blockData);
        
        // Store block data for modal
        window.blockData = blockData;
    }

    // Function to update summary cards
    function updateSummaryCards(totals) {
        // Calculate percentages
        const shgAchievement = totals.shgTarget > 0 ? (totals.shgSubmitted / totals.shgTarget) * 100 : 0;
        const individualAchievement = totals.individualTarget > 0 ? (totals.individualSubmitted / totals.individualTarget) * 100 : 0;
        const shgApprovalRate = totals.shgSubmitted > 0 ? (totals.shgSanctioned / totals.shgSubmitted) * 100 : 0;
        const individualApprovalRate = totals.individualSubmitted > 0 ? (totals.individualSanctioned / totals.individualSubmitted) * 100 : 0;
        
        // Update SHG card
        document.getElementById('shg-target-value').textContent = totals.shgTarget.toLocaleString();
        document.getElementById('shg-submitted-value').textContent = totals.shgSubmitted.toLocaleString();
        document.getElementById('shg-sanctioned-value').textContent = totals.shgSanctioned.toLocaleString();
        document.getElementById('shg-approval-value').textContent = `${shgApprovalRate.toFixed(1)}%`;
        document.getElementById('shg-achievement-value').textContent = `${shgAchievement.toFixed(1)}%`;
        
        // Update Individual card
        document.getElementById('individual-target-value').textContent = totals.individualTarget.toLocaleString();
        document.getElementById('individual-submitted-value').textContent = totals.individualSubmitted.toLocaleString();
        document.getElementById('individual-sanctioned-value').textContent = totals.individualSanctioned.toLocaleString();
        document.getElementById('individual-approval-value').textContent = `${individualApprovalRate.toFixed(1)}%`;
        document.getElementById('individual-achievement-value').textContent = `${individualAchievement.toFixed(1)}%`;
        
        // Update progress circles
        updateProgressCircle('shg-progress-circle', shgAchievement);
        updateProgressCircle('individual-progress-circle', individualAchievement);
        
        // Remove loading states
        document.querySelectorAll('.loading').forEach(el => {
            el.classList.remove('loading');
        });
    }

    // Function to update progress circle
    function updateProgressCircle(circleId, percentage) {
        const circle = document.getElementById(circleId);
        const radius = 14;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;
        
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = offset;
    }

    // Function to update charts
    function updateCharts(data) {
        // Group data by date
        const dateData = {};
        data.forEach(row => {
            if (!dateData[row.date]) {
                dateData[row.date] = {
                    shgSubmitted: 0,
                    shgSanctioned: 0,
                    individualSubmitted: 0,
                    individualSanctioned: 0
                };
            }
            
            dateData[row.date].shgSubmitted += row.shgSubmitted;
            dateData[row.date].shgSanctioned += row.shgSanctioned;
            dateData[row.date].individualSubmitted += row.individualSubmitted;
            dateData[row.date].individualSanctioned += row.individualSanctioned;
        });
        
        // Sort dates chronologically
        const sortedDates = Object.keys(dateData).sort((a, b) => {
            return new Date(a) - new Date(b);
        });
        
        // Prepare chart data
        const shgSubmittedData = sortedDates.map(date => dateData[date].shgSubmitted);
        const shgSanctionedData = sortedDates.map(date => dateData[date].shgSanctioned);
        const individualSubmittedData = sortedDates.map(date => dateData[date].individualSubmitted);
        const individualSanctionedData = sortedDates.map(date => dateData[date].individualSanctioned);
        
        // Format dates for display
        const formattedDates = sortedDates.map(date => {
            const d = new Date(date);
            return `${d.getDate()}/${d.getMonth() + 1}`;
        });
        
        // Create or update SHG chart
        const shgCtx = document.getElementById('shgLoanChart').getContext('2d');
        if (shgChart) {
            shgChart.destroy();
        }
        shgChart = new Chart(shgCtx, {
            type: 'bar',
            data: {
                labels: formattedDates,
                datasets: [
                    {
                        label: 'Submitted',
                        data: shgSubmittedData,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Sanctioned',
                        data: shgSanctionedData,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Loans'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        
        // Create or update Individual chart
        const individualCtx = document.getElementById('individualLoanChart').getContext('2d');
        if (individualChart) {
            individualChart.destroy();
        }
        individualChart = new Chart(individualCtx, {
            type: 'bar',
            data: {
                labels: formattedDates,
                datasets: [
                    {
                        label: 'Submitted',
                        data: individualSubmittedData,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Sanctioned',
                        data: individualSanctionedData,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)',
                        borderColor: 'rgba(46, 204, 113, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Loans'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    // Function to update table
    function updateTable(districtData, blockData) {
        const tableBody = document.querySelector('#loanTable tbody');
        tableBody.innerHTML = '';
        
        let grandTotal = {
            shgTarget: 0,
            shgSubmitted: 0,
            shgSanctioned: 0,
            individualTarget: 0,
            individualSubmitted: 0,
            individualSanctioned: 0
        };
        
        // Add district rows
        Object.keys(districtData).sort().forEach(district => {
            const data = districtData[district];
            
            // Calculate achievement percentages
            const shgAchievement = data.shgTarget > 0 ? (data.shgSubmitted / data.shgTarget) * 100 : 0;
            const individualAchievement = data.individualTarget > 0 ? (data.individualSubmitted / data.individualTarget) * 100 : 0;
            
            // Add district row
            const districtRow = document.createElement('tr');
            districtRow.className = 'district-row';
            districtRow.dataset.district = district;
            districtRow.innerHTML = `
                <td>${district}</td>
                <td>${targets[district]?.shg.loan.toLocaleString() || 'N/A'}</td>
                <td>${targets[district]?.shg.amount.toLocaleString() || 'N/A'}</td>
                <td>${data.shgSubmitted.toLocaleString()}</td>
                <td>${(data.shgSubmitted * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                <td>${data.shgSanctioned.toLocaleString()}</td>
                <td>${(data.shgSanctioned * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                <td>${shgAchievement.toFixed(1)}%</td>
                <td>${targets[district]?.individual.loan.toLocaleString() || 'N/A'}</td>
                <td>${targets[district]?.individual.amount.toLocaleString() || 'N/A'}</td>
                <td>${data.individualSubmitted.toLocaleString()}</td>
                <td>${(data.individualSubmitted * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                <td>${data.individualSanctioned.toLocaleString()}</td>
                <td>${(data.individualSanctioned * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                <td>${individualAchievement.toFixed(1)}%</td>
            `;
            tableBody.appendChild(districtRow);
            
            // Add block rows for this district
            Object.keys(blockData)
                .filter(key => blockData[key].district === district)
                .sort((a, b) => blockData[a].block.localeCompare(blockData[b].block))
                .forEach(key => {
                    const block = blockData[key];
                    
                    // Calculate achievement percentages
                    const blockShgAchievement = block.shgTarget > 0 ? (block.shgSubmitted / block.shgTarget) * 100 : 0;
                    const blockIndividualAchievement = block.individualTarget > 0 ? (block.individualSubmitted / block.individualTarget) * 100 : 0;
                    
                    const blockRow = document.createElement('tr');
                    blockRow.className = 'block-row';
                    blockRow.dataset.district = district;
                    blockRow.dataset.block = block.block;
                    blockRow.innerHTML = `
                        <td>${block.block}</td>
                        <td>${blockTargets[block.block]?.shg.loan.toLocaleString() || 'N/A'}</td>
                        <td>${blockTargets[block.block]?.shg.amount.toLocaleString() || 'N/A'}</td>
                        <td>${block.shgSubmitted.toLocaleString()}</td>
                        <td>${(block.shgSubmitted * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td>${block.shgSanctioned.toLocaleString()}</td>
                        <td>${(block.shgSanctioned * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td>${blockShgAchievement.toFixed(1)}%</td>
                        <td>${blockTargets[block.block]?.individual.loan.toLocaleString() || 'N/A'}</td>
                        <td>${blockTargets[block.block]?.individual.amount.toLocaleString() || 'N/A'}</td>
                        <td>${block.individualSubmitted.toLocaleString()}</td>
                        <td>${(block.individualSubmitted * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td>${block.individualSanctioned.toLocaleString()}</td>
                        <td>${(block.individualSanctioned * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                        <td>${blockIndividualAchievement.toFixed(1)}%</td>
                    `;
                    tableBody.appendChild(blockRow);
                });
            
            // Update grand totals
            grandTotal.shgTarget += data.shgTarget;
            grandTotal.shgSubmitted += data.shgSubmitted;
            grandTotal.shgSanctioned += data.shgSanctioned;
            grandTotal.individualTarget += data.individualTarget;
            grandTotal.individualSubmitted += data.individualSubmitted;
            grandTotal.individualSanctioned += data.individualSanctioned;
        });
        
        // Add grand total row
        const shgAchievement = grandTotal.shgTarget > 0 ? (grandTotal.shgSubmitted / grandTotal.shgTarget) * 100 : 0;
        const individualAchievement = grandTotal.individualTarget > 0 ? (grandTotal.individualSubmitted / grandTotal.individualTarget) * 100 : 0;
        
        const totalRow = document.createElement('tr');
        totalRow.className = 'summary-row';
        totalRow.innerHTML = `
            <td>GRAND TOTAL</td>
            <td>${Object.values(targets).reduce((sum, target) => sum + target.shg.loan, 0).toLocaleString()}</td>
            <td>${Object.values(targets).reduce((sum, target) => sum + target.shg.amount, 0).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${grandTotal.shgSubmitted.toLocaleString()}</td>
            <td>${(grandTotal.shgSubmitted * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${grandTotal.shgSanctioned.toLocaleString()}</td>
            <td>${(grandTotal.shgSanctioned * 3.13).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${shgAchievement.toFixed(1)}%</td>
            <td>${Object.values(targets).reduce((sum, target) => sum + target.individual.loan, 0).toLocaleString()}</td>
            <td>${Object.values(targets).reduce((sum, target) => sum + target.individual.amount, 0).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${grandTotal.individualSubmitted.toLocaleString()}</td>
            <td>${(grandTotal.individualSubmitted * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${grandTotal.individualSanctioned.toLocaleString()}</td>
            <td>${(grandTotal.individualSanctioned * 2).toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
            <td>${individualAchievement.toFixed(1)}%</td>
        `;
        tableBody.appendChild(totalRow);
        
        // Add event listeners for expand/collapse
        document.querySelectorAll('.district-row').forEach(row => {
            row.addEventListener('click', function() {
                const district = this.dataset.district;
                const blockRows = document.querySelectorAll(`.block-row[data-district="${district}"]`);
                
                let allVisible = true;
                blockRows.forEach(blockRow => {
                    if (blockRow.style.display !== 'none') {
                        allVisible = false;
                    }
                });
                
                blockRows.forEach(blockRow => {
                    blockRow.style.display = allVisible ? 'table-row' : 'none';
                });
            });
        });
        
        // Initially hide all block rows
        document.querySelectorAll('.block-row').forEach(row => {
            row.style.display = 'none';
        });
    }

    // Function to show block details in modal
    function showBlockDetails(district, block) {
        const blockKey = `${district}-${block}`;
        const data = window.blockData[blockKey];
        
        if (!data) return;
        
        // Update modal title
        document.getElementById('blockNameTitle').textContent = `${block} (${district})`;
        
        // Prepare data for the chart
        const sortedDailyData = data.dailyData.sort((a, b) => new Date(a.date) - new Date(b.date));
        const dates = sortedDailyData.map(d => {
            const dateObj = new Date(d.date);
            return `${dateObj.getDate()}/${dateObj.getMonth() + 1}`;
        });
        
        const shgSubmitted = sortedDailyData.map(d => d.shgSubmitted);
        const shgSanctioned = sortedDailyData.map(d => d.shgSanctioned);
        const individualSubmitted = sortedDailyData.map(d => d.individualSubmitted);
        const individualSanctioned = sortedDailyData.map(d => d.individualSanctioned);
        
        // Create or update the chart
        const ctx = document.getElementById('blockDetailChart').getContext('2d');
        if (blockDetailChart) {
            blockDetailChart.destroy();
        }
        
        blockDetailChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'SHG Submitted',
                        data: shgSubmitted,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'SHG Sanctioned',
                        data: shgSanctioned,
                        borderColor: 'rgba(46, 204, 113, 1)',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Individual Submitted',
                        data: individualSubmitted,
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Individual Sanctioned',
                        data: individualSanctioned,
                        borderColor: 'rgba(241, 196, 15, 1)',
                        backgroundColor: 'rgba(241, 196, 15, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Loans'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        
        // Update the table with daily data
        const tableBody = document.getElementById('blockDetailBody');
        tableBody.innerHTML = '';
        
        sortedDailyData.forEach(day => {
            const row = document.createElement('tr');
            const dateObj = new Date(day.date);
            const formattedDate = `${dateObj.getDate()}/${dateObj.getMonth() + 1}/${dateObj.getFullYear()}`;
            
            row.innerHTML = `
                <td>${formattedDate}</td>
                <td>${day.shgTarget}</td>
                <td>${day.shgSubmitted}</td>
                <td>${day.shgSanctioned}</td>
                <td>${day.individualTarget}</td>
                <td>${day.individualSubmitted}</td>
                <td>${day.individualSanctioned}</td>
            `;
            tableBody.appendChild(row);
        });
        
        // Update the summary cards
        updateBlockSummaryCards(data, block);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('blockDetailsModal'));
        modal.show();
    }

    // Function to update block summary cards
    function updateBlockSummaryCards(data, block) {
        const shgContainer = document.getElementById('shg-summary-cards');
        const individualContainer = document.getElementById('individual-summary-cards');
        
        // Clear previous cards
        shgContainer.innerHTML = '';
        individualContainer.innerHTML = '';
        
        // Get block targets
        const blockTarget = blockTargets[block] || { shg: { loan: 0, amount: 0 }, individual: { loan: 0, amount: 0 } };
        
        // Calculate metrics for SHG
        const shgAchievement = blockTarget.shg.loan > 0 ? (data.shgSubmitted / blockTarget.shg.loan) * 100 : 0;
        const shgApprovalRate = data.shgSubmitted > 0 ? (data.shgSanctioned / data.shgSubmitted) * 100 : 0;
        const shgAvgLoanSize = data.shgSubmitted > 0 ? (data.shgSubmitted * 3.13) / data.shgSubmitted : 0;
        
        // Calculate metrics for Individual
        const individualAchievement = blockTarget.individual.loan > 0 ? (data.individualSubmitted / blockTarget.individual.loan) * 100 : 0;
        const individualApprovalRate = data.individualSubmitted > 0 ? (data.individualSanctioned / data.individualSubmitted) * 100 : 0;
        const individualAvgLoanSize = data.individualSubmitted > 0 ? (data.individualSubmitted * 2) / data.individualSubmitted : 0;
        
        // Create SHG summary cards
        const shgCards = [
            { title: 'Target', value: blockTarget.shg.loan, target: blockTarget.shg.loan, type: 'number' },
            { title: 'Submitted', value: data.shgSubmitted, target: blockTarget.shg.loan, type: 'number' },
            { title: 'Sanctioned', value: data.shgSanctioned, target: data.shgSubmitted, type: 'number' },
            { title: 'Achievement', value: shgAchievement, target: 100, type: 'percentage' },
            { title: 'Approval Rate', value: shgApprovalRate, target: 100, type: 'percentage' },
            { title: 'Avg Loan Size', value: shgAvgLoanSize, target: 3.13, type: 'amount' }
        ];
        
        shgCards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'block-summary-card shg-card-style';
            
            const progressWidth = card.target > 0 ? Math.min((card.value / card.target) * 100, 100) : 0;
            
            cardEl.innerHTML = `
                <div class="block-summary-title">${card.title}</div>
                <div class="block-summary-value">${card.type === 'percentage' ? card.value.toFixed(1) + '%' : card.type === 'amount' ? '₹' + card.value.toFixed(2) + 'L' : card.value.toLocaleString()}</div>
                <div class="block-summary-target">
                    <span>Target: ${card.type === 'percentage' ? '100%' : card.type === 'amount' ? '₹' + card.target.toFixed(2) + 'L' : card.target.toLocaleString()}</span>
                </div>
                <div class="day-progress">
                    <div class="day-progress-bar shg-progress" style="width: ${progressWidth}%"></div>
                </div>
            `;
            
            shgContainer.appendChild(cardEl);
        });
        
        // Create Individual summary cards
        const individualCards = [
            { title: 'Target', value: blockTarget.individual.loan, target: blockTarget.individual.loan, type: 'number' },
            { title: 'Submitted', value: data.individualSubmitted, target: blockTarget.individual.loan, type: 'number' },
            { title: 'Sanctioned', value: data.individualSanctioned, target: data.individualSubmitted, type: 'number' },
            { title: 'Achievement', value: individualAchievement, target: 100, type: 'percentage' },
            { title: 'Approval Rate', value: individualApprovalRate, target: 100, type: 'percentage' },
            { title: 'Avg Loan Size', value: individualAvgLoanSize, target: 2, type: 'amount' }
        ];
        
        individualCards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'block-summary-card individual-card-style';
            
            const progressWidth = card.target > 0 ? Math.min((card.value / card.target) * 100, 100) : 0;
            
            cardEl.innerHTML = `
                <div class="block-summary-title">${card.title}</div>
                <div class="block-summary-value">${card.type === 'percentage' ? card.value.toFixed(1) + '%' : card.type === 'amount' ? '₹' + card.value.toFixed(2) + 'L' : card.value.toLocaleString()}</div>
                <div class="block-summary-target">
                    <span>Target: ${card.type === 'percentage' ? '100%' : card.type === 'amount' ? '₹' + card.target.toFixed(2) + 'L' : card.target.toLocaleString()}</span>
                </div>
                <div class="day-progress">
                    <div class="day-progress-bar individual-progress" style="width: ${progressWidth}%"></div>
                </div>
            `;
            
            individualContainer.appendChild(cardEl);
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Load data
        loadCSVData();
        
        // Toggle all districts
        document.getElementById('toggleAll').addEventListener('click', function() {
            const blockRows = document.querySelectorAll('.block-row');
            const allVisible = blockRows[0]?.style.display !== 'none';
            
            blockRows.forEach(row => {
                row.style.display = allVisible ? 'none' : 'table-row';
            });
        });
        
        // Font size controls
        document.getElementById('decrease-font').addEventListener('click', function() {
            if (currentFontSize > 14) {
                currentFontSize -= 2;
                updateTableFontSize();
            }
        });
        
        document.getElementById('reset-font').addEventListener('click', function() {
            currentFontSize = 16;
            updateTableFontSize();
        });
        
        document.getElementById('increase-font').addEventListener('click', function() {
            if (currentFontSize < 20) {
                currentFontSize += 2;
                updateTableFontSize();
            }
        });
        
        // Add event listeners to block rows for showing details
        document.addEventListener('click', function(e) {
            const blockRow = e.target.closest('.block-row');
            if (blockRow) {
                const district = blockRow.dataset.district;
                const block = blockRow.dataset.block;
                showBlockDetails(district, block);
            }
        });
    });

    // Function to update table font size
    function updateTableFontSize() {
        const table = document.getElementById('loanTable');
        table.style.fontSize = currentFontSize + 'px';
        
        // Update button states
        document.getElementById('decrease-font').disabled = currentFontSize <= 14;
        document.getElementById('increase-font').disabled = currentFontSize >= 20;
    }
    </script>
</body>
</html>
