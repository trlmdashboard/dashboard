<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHG Loan Progress Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* All CSS remains exactly the same */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 20px;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }
        .header-logos {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            box-sizing: border-box;
        }
        .header-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .summary-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .summary-card {
            flex: 1;
            min-width: 300px;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            border: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }
        .card-header {
            padding: 15px 20px;
            color: white;
            position: relative;
            z-index: 1;
        }
        .shg-card {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .shg-card .card-header {
            background: rgba(0, 0, 0, 0.15);
        }
        .shg-card .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .individual-card {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .individual-card .card-header {
            background: rgba(0, 0, 0, 0.15);
        }
        .individual-card .stat-label {
            color: rgba(255, 255, 255, 0.8);
        }
        .card-body {
            padding: 15px;
            position: relative;
            display: flex;
            align-items: center;
        }
        .progress-circle-container {
            flex: 0 0 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 20px;
        }
        .progress-circle {
            width: 80px;
            height: 80px;
            position: relative;
        }
        .progress-circle svg {
            width: 100%;
            height: 100%;
        }
        .progress-circle circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        .progress-circle-bg {
            stroke: rgba(255, 255, 255, 0.2);
        }
        .shg-card .progress-circle-fill {
            stroke: white;
        }
        .individual-card .progress-circle-fill {
            stroke: white;
        }
        .progress-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.6em;
            font-weight: bold;
            color: white;
        }
        .stats-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 5px;
            min-height: 1.5em;
            color: white;
        }
        .card-pattern {
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            opacity: 0.1;
        }
        .shg-card .card-pattern {
            background: radial-gradient(circle, white 0%, transparent 70%);
        }
        .individual-card .card-pattern {
            background: radial-gradient(circle, white 0%, transparent 70%);
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            height: 220px;
        }
        .chart-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #34495e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .data-table {
            font-size: 16px;
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .data-table th, .data-table td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: center;
        }
        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: relative;
            color: #34495e;
            font-size: 0.95em;
        }
        .group-header {
            background-color: #e9ecef !important;
            font-weight: 700;
            text-align: center !important;
            font-size: 1em;
        }
        .data-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        .data-table tr:hover {
            background-color: #f1f7ff;
        }
        .district-row {
            cursor: pointer;
            font-weight: bold;
            background-color: #e6f0ff;
            font-size: 1.05em;
        }
        .block-row td:first-child {
            text-align: left;
            padding-left: 40px !important;
            font-size: 0.95em;
        }
        .summary-row {
            font-weight: 600;
            background-color: rgba(52, 152, 219, 0.1);
            font-size: 1.05em;
        }
        .recent-submission {
            font-size: 0.85em;
            background-color: #27ae60;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 3px;
            font-weight: 500;
        }
        .amount-cell {
            font-size: 0.95em;
            color: #7f8c8d;
        }
        .progress-thin {
            height: 6px;
            margin-bottom: 5px;
        }
        .progress-thin .progress-bar {
            border-radius: 3px;
        }
        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .progress-container .progress {
            width: 100%;
        }
        .text-center {
            text-align: center;
        }
        .mt-1 {
            margin-top: 4px;
        }
        .last3-days {
            font-size: 0.85em;
            color: #27ae60;
            font-weight: 500;
            margin-top: 4px;
        }
        .no-progress {
            font-size: 0.85em;
            color: #95a5a6;
            font-style: italic;
            margin-top: 4px;
        }
        .last3-days-badge {
            background-color: #e8f5e9;
            color: #27ae60;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-block;
            margin-top: 3px;
        }
        .highlight-section {
            background-color: #e8f5e9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .loading {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            color: transparent;
            position: relative;
            overflow: hidden;
            display: inline-block;
            min-width: 60px;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-circle.loading circle {
            stroke: rgba(255, 255, 255, 0.3);
        }
        .progress-value.loading {
            width: 50px;
            height: 24px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .btn-expand {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        .btn-expand:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            color: white;
        }
        .info-icon {
            color: #3498db;
            cursor: pointer;
            margin-left: 5px;
            font-size: 16px;
        }
        .info-icon:hover {
            color: #2980b9;
        }
        .modal-content {
            border-radius: 12px;
            overflow: hidden;
        }
        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        .modal-title {
            font-weight: 600;
        }
        .modal-body {
            padding: 20px;
        }
        .block-detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        .block-detail-table th {
            background-color: #3498db;
            color: white;
            padding: 10px;
            text-align: center;
        }
        .block-detail-table td {
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }
        .block-detail-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .block-detail-table tr:hover {
            background-color: #e6f0ff;
        }
        .detail-chart-container {
            height: 250px;
            margin-top: 20px;
        }
        .block-summary-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: space-between;
        }
        .block-summary-section {
            flex: 1;
            min-width: 300px;
        }
        .section-header {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .shg-header {
            color: #3498db;
            border-color: #3498db;
        }
        .individual-header {
            color: #e74c3c;
            border-color: #e74c3c;
        }
        .block-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        .block-summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .block-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .shg-card-style {
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
        }
        .individual-card-style {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        .block-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .block-summary-title {
            font-size: 0.85em;
            margin-bottom: 5px;
            color: rgba(255,255,255,0.85);
        }
        .block-summary-card .block-summary-title {
            font-weight: 500;
        }
        .block-summary-value {
            font-size: 1.6em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .shg-card-style .block-summary-value {
            color: white;
        }
        .individual-card-style .block-summary-value {
            color: white;
        }
        .block-summary-target {
            font-size: 0.8em;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        .achievement-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-top: 5px;
        }
        .shg-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .individual-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .day-progress {
            width: 100%;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .day-progress-bar {
            height: 100%;
        }
        .shg-progress {
            background: rgba(255,255,255,0.6);
        }
        .individual-progress {
            background: rgba(255,255,255,0.6);
        }
        .achievement-line {
            border-top: 2px dashed #7f8c8d;
            position: relative;
            margin-top: 10px;
        }
        .achievement-line::after {
            content: 'Target Achievement';
            position: absolute;
            right: 0;
            top: -10px;
            background: white;
            padding: 0 5px;
            color: #7f8c8d;
            font-size: 12px;
        }
        .table-controls {
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .table-controls span {
            font-weight: 500;
            color: #495057;
        }
        #decrease-font, #reset-font, #increase-font {
            width: 40px;
        }
        .font-sm {
            font-size: 14px !important;
        }
        .font-md {
            font-size: 16px !important;
        }
        .font-lg {
            font-size: 18px !important;
        }
        .font-xl {
            font-size: 20px !important;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-logos">
            <img src="https://pbs.twimg.com/profile_images/1524416655140753408/yXqxucvR_400x400.jpg" class="header-logo" alt="Logo 1">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/Tripura_Emblem.png/330px-Tripura_Emblem.png" class="header-logo" alt="Tripura Emblem">
        </div>
        <div class="container"><center>
            <h1><i class="bi bi-graph-up"></i> "SAMRIDDHI" CAMPAIGN - DASHBOARD</h1>
            <p class="mb-0">(Mahilader Arthik Khomotayoner Jonyo Ek Ononyo Podokhyep)</br>(1st August to 31st August, 2025)</p>
        </center></div>
    </div>

    <div class="container">
        <div class="summary-cards">
            <div class="summary-card shg-card">
                <div class="card-header">
                    <h4><i class="bi bi-people-fill"></i> SHG Loan Summary</h4>
                    <div class="card-pattern"></div>
                </div>
                <div class="card-body">
                    <div class="progress-circle-container">
                        <div class="progress-circle loading">
                            <svg viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
                                <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="shg-progress-circle"></circle>
                            </svg>
                            <div class="progress-value loading" id="shg-achievement-value"></div>
                        </div>
                    </div>
                    <div class="stats-container">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-target-value"></div>
                                <div class="stat-label">Target</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-submitted-value"></div>
                                <div class="stat-label">Submitted</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-sanctioned-value"></div>
                                <div class="stat-label">Sanctioned</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="shg-approval-value"></div>
                                <div class="stat-label">Approval Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="summary-card individual-card">
                <div class="card-header">
                    <h4><i class="bi bi-person-fill"></i> Individual Loan Summary</h4>
                    <div class="card-pattern"></div>
                </div>
                <div class="card-body">
                    <div class="progress-circle-container">
                        <div class="progress-circle loading">
                            <svg viewBox="0 0 36 36">
                                <circle class="progress-circle-bg" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0"></circle>
                                <circle class="progress-circle-fill" cx="18" cy="18" r="14" stroke-dasharray="87.96" stroke-dashoffset="0" id="individual-progress-circle"></circle>
                            </svg>
                            <div class="progress-value loading" id="individual-achievement-value"></div>
                        </div>
                    </div>
                    <div class="stats-container">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-target-value"></div>
                                <div class="stat-label">Target</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-submitted-value"></div>
                                <div class="stat-label">Submitted</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-sanctioned-value"></div>
                                <div class="stat-label">Sanctioned</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value loading" id="individual-approval-value"></div>
                                <div class="stat-label">Approval Rate</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SHG Loan Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-people-fill" style="color: #3498db;"></i> SHG Loan - Daily Submitted vs Sanctioned
            </div>
            <canvas id="shgLoanChart"></canvas>
        </div>
        
        <!-- Individual Loan Chart -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="bi bi-person-fill" style="color: #e74c3c;"></i> Individual Loan - Daily Submitted vs Sanctioned
            </div>
            <canvas id="individualLoanChart"></canvas>
        </div>
        
        <button class="btn-expand" id="toggleAll">
            <i class="bi bi-arrows-angle-expand"></i> Expand/Collapse All Districts
        </button>
        
        <div class="table-controls mb-3 d-flex justify-content-end align-items-center" style="width:100%;">
            <span class="me-2">Table Font Size:</span>
            <div class="btn-group">
                <button class="btn btn-outline-secondary" id="decrease-font" title="Decrease font size">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button class="btn btn-outline-secondary" id="reset-font" title="Reset to default">
                    <i class="bi bi-fonts"></i>
                </button>
                <button class="btn btn-outline-secondary" id="increase-font" title="Increase font size">
                    <i class="bi bi-plus-lg"></i>
                </button>
            </div>
        </div>
    </div>

    <table class="data-table" id="loanTable">
        <thead>
            <tr>
                <th rowspan="2">District / Block Name</th>
                <th colspan="7" class="group-header">SHG Loan</th>
                <th colspan="7" class="group-header">Individual Loan</th>
            </tr>
            <tr>
                <th>Target</th>
                <th>Target Amount (₹ Lakh)</th>
                <th>Submitted</th>
                <th>Submitted Amount (₹ Lakh)</th>
                <th>Sanctioned</th>
                <th>Sanctioned Amount (₹ Lakh)</th>
                <th>Achievement (%)</th>
                <th>Target</th>
                <th>Target Amount (₹ Lakh)</th>
                <th>Submitted</th>
                <th>Submitted Amount (₹ Lakh)</th>
                <th>Sanctioned</th>
                <th>Sanctioned Amount (₹ Lakh)</th>
                <th>Achievement (%)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Block Details Modal -->
    <div class="modal fade" id="blockDetailsModal" tabindex="-1" aria-labelledby="blockDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blockDetailsModalLabel">Block Details: <span id="blockNameTitle">Loading...</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="detail-chart-container">
                        <canvas id="blockDetailChart"></canvas>
                    </div>
                    
                    <!-- Enhanced Block Summary Cards -->
                    <div class="block-summary-container">
                        <div class="block-summary-section">
                            <div class="section-header shg-header">
                                <i class="bi bi-people-fill"></i> SHG Loan Summary
                            </div>
                            <div class="block-summary-grid" id="shg-summary-cards">
                                <!-- Cards will be inserted here by JavaScript -->
                            </div>
                        </div>
                        
                        <div class="block-summary-section">
                            <div class="section-header individual-header">
                                <i class="bi bi-person-fill"></i> Individual Loan Summary
                            </div>
                            <div class="block-summary-grid" id="individual-summary-cards">
                                <!-- Cards will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4"><i class="bi bi-calendar-date"></i> Day-wise Progress</h5>
                    <div class="table-responsive">
                        <table class="block-detail-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>SHG Target</th>
                                    <th>SHG Submitted</th>
                                    <th>SHG Sanctioned</th>
                                    <th>Individual Target</th>
                                    <th>Individual Submitted</th>
                                    <th>Individual Sanctioned</th>
                                </tr>
                            </thead>
                            <tbody id="blockDetailBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Updated CSV URL
    const csvUrl = "https://docs.google.com/spreadsheets/d/1E-GGB71B_JViWKcKL7osFwav6GvMR2lAH8Taaucz7tM/gviz/tq?tqx=out:csv&sheet=jsondata";

    // District targets for both SHG and Individual loans
    const targets = {
        "DHALAI": { shg: { loan: 800, amount: 2504 }, individual: { loan: 135, amount: 270 } },
        "GOMATI": { shg: { loan: 850, amount: 2660.5 }, individual: { loan: 135, amount: 270 } },
        "KHOWAI": { shg: { loan: 500, amount: 1565 }, individual: { loan: 85, amount: 170 } },
        "NORTH TRIPURA": { shg: { loan: 510, amount: 1596.3 }, individual: { loan: 100, amount: 200 } },
        "SEPAHIJALA": { shg: { loan: 600, amount: 1878 }, individual: { loan: 85, amount: 170 } },
        "SOUTH TRIPURA": { shg: { loan: 750, amount: 2347.5 }, individual: { loan: 135, amount: 270 } },
        "UNAKOTI": { shg: { loan: 400, amount: 1252 }, individual: { loan: 70, amount: 140 } },
        "WEST TRIPURA": { shg: { loan: 840, amount: 2629.2 }, individual: { loan: 135, amount: 270 } }
    };

    // Block targets for both SHG and Individual loans
    const blockTargets = {
        "BC NAGAR": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "BOKAFA": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 18, amount: 36 } },
        "HRISHYAMUKH": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 19, amount: 38 } },
        "JOLAIBARI": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 23, amount: 46 } },
        "POANGBARI": { shg: { loan: 30, amount: 93.9 }, individual: { loan: 8, amount: 16 } },
        "RAJNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 19, amount: 38 } },
        "RUPAICHARI": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 11, amount: 22 } },
        "SATCHAND": { shg: { loan: 130, amount: 406.9 }, individual: { loan: 22, amount: 44 } },
        "DAMCHERRA": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 12, amount: 24 } },
        "DASDA": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 12, amount: 24 } },
        "JAMPUI HILLS": { shg: { loan: 15, amount: 46.95 }, individual: { loan: 6, amount: 12 } },
        "JUBARAJNAGAR": { shg: { loan: 90, amount: 281.7 }, individual: { loan: 15, amount: 30 } },
        "KADAMTALA": { shg: { loan: 100, amount: 313 }, individual: { loan: 15, amount: 30 } },
        "KALACHERRA": { shg: { loan: 70, amount: 219.1 }, individual: { loan: 15, amount: 30 } },
        "LALJURI": { shg: { loan: 60, amount: 187.8 }, individual: { loan: 10, amount: 20 } },
        "PANISAGAR": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 15, amount: 30 } },
        "CHANDIPUR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 12, amount: 24 } },
        "GOURNAGAR": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 21, amount: 42 } },
        "KUMARGHAT": { shg: { loan: 135, amount: 422.55 }, individual: { loan: 24, amount: 48 } },
        "PECHARTHAL": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 13, amount: 26 } },
        "SALEMA": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 15, amount: 30 } },
        "AMBASSA": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 25, amount: 50 } },
        "CHAWMANU": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 14, amount: 28 } },
        "DUMBURNAGAR": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 21, amount: 42 } },
        "DURGACHOWMUHANI": { shg: { loan: 180, amount: 563.4 }, individual: { loan: 21, amount: 42 } },
        "GANGANAGAR": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 6, amount: 12 } },
        "MANU": { shg: { loan: 170, amount: 532.1 }, individual: { loan: 25, amount: 50 } },
        "RAISHYABARI": { shg: { loan: 35, amount: 109.55 }, individual: { loan: 8, amount: 16 } },
        "KALYANPUR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 14, amount: 28 } },
        "KHOWAI": { shg: { loan: 110, amount: 344.3 }, individual: { loan: 18, amount: 36 } },
        "MUNGIAKAMI": { shg: { loan: 45, amount: 140.85 }, individual: { loan: 10, amount: 20 } },
        "PADMABIL": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 10, amount: 20 } },
        "TELIAMURA": { shg: { loan: 100, amount: 313 }, individual: { loan: 18, amount: 36 } },
        "TULASHIKHAR": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 15, amount: 30 } },
        "BAMUTIA": { shg: { loan: 120, amount: 375.6 }, individual: { loan: 14, amount: 28 } },
        "BELBARI": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 14, amount: 28 } },
        "DUKLI": { shg: { loan: 155, amount: 485.15 }, individual: { loan: 19, amount: 38 } },
        "HEZAMARA": { shg: { loan: 60, amount: 187.8 }, individual: { loan: 13, amount: 26 } },
        "JIRANIA": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 14, amount: 28 } },
        "LEFUNGA": { shg: { loan: 55, amount: 172.15 }, individual: { loan: 13, amount: 26 } },
        "MANDWI": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 13, amount: 26 } },
        "MOHANPUR": { shg: { loan: 95, amount: 297.35 }, individual: { loan: 14, amount: 28 } },
        "OLD AGARTALA": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 21, amount: 42 } },
        "BISHALGARH": { shg: { loan: 100, amount: 313 }, individual: { loan: 16, amount: 32 } },
        "BOXANAGAR": { shg: { loan: 70, amount: 219.1 }, individual: { loan: 10, amount: 20 } },
        "CHARILAM": { shg: { loan: 75, amount: 234.75 }, individual: { loan: 14, amount: 28 } },
        "JAMPUIJALA": { shg: { loan: 95, amount: 297.35 }, individual: { loan: 10, amount: 20 } },
        "KATAHALIA": { shg: { loan: 80, amount: 250.4 }, individual: { loan: 13, amount: 26 } },
        "MOHANBHOG": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 8, amount: 16 } },
        "NALCHAR": { shg: { loan: 115, amount: 359.95 }, individual: { loan: 14, amount: 28 } },
        "AMARPUR": { shg: { loan: 95, amount: 297.35 }, individual: { loan: 13, amount: 26 } },
        "KAKRABAN": { shg: { loan: 130, amount: 406.9 }, individual: { loan: 18, amount: 36 } },
        "KARBOOK": { shg: { loan: 105, amount: 328.65 }, individual: { loan: 12, amount: 24 } },
        "KILLA": { shg: { loan: 65, amount: 203.45 }, individual: { loan: 18, amount: 36 } },
        "MATABARI": { shg: { loan: 180, amount: 563.4 }, individual: { loan: 25, amount: 50 } },
        "OMPI": { shg: { loan: 85, amount: 266.05 }, individual: { loan: 12, amount: 24 } },
        "SILACHARI": { shg: { loan: 50, amount: 156.5 }, individual: { loan: 12, amount: 24 } },
        "TEPANIA": { shg: { loan: 140, amount: 438.2 }, individual: { loan: 25, amount: 50 } }
    };

    // Get current date to determine how many days to show in charts
    function getCurrentDate() {
        const today = new Date();
        const campaignStart = new Date(2025, 7, 1); // August 1, 2025 (month is 0-indexed)
        
        // If current date is before campaign start, show first day only
        if (today < campaignStart) return 1;
        
        // If current date is after campaign end, show all 31 days
        const campaignEnd = new Date(2025, 7, 31);
        if (today > campaignEnd) return 31;
        
        // Otherwise show days up to current date
        return today.getDate();
    }

    const daysToShow = getCurrentDate();

    // Function to get day columns (1-31 August 2025 and 1-7 September 2025)
    function getDayColumns() {
        const columns = [];
        
        // August days (1-31)
        for (let day = 1; day <= 31; day++) {
            const dayOffset = (day - 1) * 8;
            columns.push({
                date: `${day}-08-2025`,
                shgSubmittedCount: 4 + dayOffset,
                shgSubmittedAmt: 5 + dayOffset,
                shgSanctionedCount: 6 + dayOffset,
                shgSanctionedAmt: 7 + dayOffset,
                individualSubmittedCount: 8 + dayOffset,
                individualSubmittedAmt: 9 + dayOffset,
                individualSanctionedCount: 10 + dayOffset,
                individualSanctionedAmt: 11 + dayOffset
            });
        }
        
        // September days (1-7)
        for (let day = 1; day <= 7; day++) {
            const dayOffset = 248 + (day - 1) * 8; // 248 = 31 days * 8 columns
            columns.push({
                date: `${day}-09-2025`,
                shgSubmittedCount: dayOffset,
                shgSubmittedAmt: dayOffset + 1,
                shgSanctionedCount: dayOffset + 2,
                shgSanctionedAmt: dayOffset + 3,
                individualSubmittedCount: dayOffset + 4,
                individualSubmittedAmt: dayOffset + 5,
                individualSanctionedCount: dayOffset + 6,
                individualSanctionedAmt: dayOffset + 7
            });
        }
        
        return columns;
    }

    const dayColumns = getDayColumns();

    // Function to animate numbers counting up
    function animateCountUp(element, target, duration = 1500, isPercentage = false) {
        const start = 0;
        const increment = target / (duration / 16);
        let current = start;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                clearInterval(timer);
                current = target;
            }
            
            if (isPercentage) {
                element.textContent = `${Math.round(current)}%`;
            } else {
                element.textContent = formatInt(Math.round(current));
            }
        }, 16);
    }

    // Function to remove loading animations
    function removeLoadingAnimations() {
        document.querySelectorAll('.loading').forEach(el => {
            el.classList.remove('loading');
        });
        document.querySelectorAll('.progress-circle.loading circle').forEach(el => {
            el.style.stroke = '';
        });
    }

    // Function to create a summary card for the block modal
    function createSummaryCard(title, value, target, type) {
        const achievement = target ? Math.round((value / target) * 100) : 0;
        
        const card = document.createElement('div');
        card.className = `block-summary-card ${type}-card-style`;
        
        card.innerHTML = `
            <div class="block-summary-title">${title}</div>
            <div class="block-summary-value">${formatInt(value)}</div>
            <div class="block-summary-target">
                <span>Target: ${formatInt(target)}</span>
                <span class="achievement-badge ${type}-badge">${achievement}%</span>
            </div>
            <div class="day-progress">
                <div class="day-progress-bar ${type}-progress" style="width: ${Math.min(achievement, 100)}%"></div>
            </div>
        `;
        
        return card;
    }

    // Function to show block details
    function showBlockDetails(district, block) {
        const modal = new bootstrap.Modal(document.getElementById('blockDetailsModal'));
        document.getElementById('blockNameTitle').textContent = `${block} (${district})`;
        
        // Simulate data loading
        const tbody = document.getElementById('blockDetailBody');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading data...</td></tr>';
        
        // Clear previous cards
        document.getElementById('shg-summary-cards').innerHTML = '';
        document.getElementById('individual-summary-cards').innerHTML = '';
        
        modal.show();
        
        // Find the row for this block in the CSV data
        const blockRow = window.csvData.find(row => 
            row[0].trim().toUpperCase() === district && 
            row[1].trim().toUpperCase() === block.toUpperCase()
        );
        
        if (!blockRow) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No data found for this block</td></tr>';
            return;
        }
        
        // Get block targets
        const shgTarget = blockTargets[block]?.shg.loan || 0;
        const shgTargetAmt = blockTargets[block]?.shg.amount || 0;
        const indTarget = blockTargets[block]?.individual.loan || 0;
        const indTargetAmt = blockTargets[block]?.individual.amount || 0;
        
        // Initialize totals
        let shgSubmittedTotal = 0;
        let shgSanctionedTotal = 0;
        let shgSubmittedAmtTotal = 0;
        let shgSanctionedAmtTotal = 0;
        
        let indSubmittedTotal = 0;
        let indSanctionedTotal = 0;
        let indSubmittedAmtTotal = 0;
        let indSanctionedAmtTotal = 0;
        
        // Prepare data for the chart
        const shgSubmittedData = [];
        const shgSanctionedData = [];
        const indSubmittedData = [];
        const indSanctionedData = [];
        const labels = [];
        
        tbody.innerHTML = '';
        
        // Process each day's data for August only (1-31)
        dayColumns.slice(0, 31).forEach((day, index) => {
            const date = `${day.date.split('-')[0]} Aug`;
            labels.push(date);
            
            // Get day-wise data from CSV
            const shgSubmitted = parseFloat(blockRow[day.shgSubmittedCount]) || 0;
            const shgSubmittedAmt = parseFloat(blockRow[day.shgSubmittedAmt]) || 0;
            const shgSanctioned = parseFloat(blockRow[day.shgSanctionedCount]) || 0;
            const shgSanctionedAmt = parseFloat(blockRow[day.shgSanctionedAmt]) || 0;
            
            const indSubmitted = parseFloat(blockRow[day.individualSubmittedCount]) || 0;
            const indSubmittedAmt = parseFloat(blockRow[day.individualSubmittedAmt]) || 0;
            const indSanctioned = parseFloat(blockRow[day.individualSanctionedCount]) || 0;
            const indSanctionedAmt = parseFloat(blockRow[day.individualSanctionedAmt]) || 0;
            
            // Accumulate totals
            shgSubmittedTotal += shgSubmitted;
            shgSanctionedTotal += shgSanctioned;
            shgSubmittedAmtTotal += shgSubmittedAmt;
            shgSanctionedAmtTotal += shgSanctionedAmt;
            
            indSubmittedTotal += indSubmitted;
            indSanctionedTotal += indSanctioned;
            indSubmittedAmtTotal += indSubmittedAmt;
            indSanctionedAmtTotal += indSanctionedAmt;
            
            shgSubmittedData.push(shgSubmitted);
            shgSanctionedData.push(shgSanctioned);
            indSubmittedData.push(indSubmitted);
            indSanctionedData.push(indSanctioned);
            
            // Add row to table
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${date}</td>
                <td>${formatInt(shgTarget)}</td>
                <td>${formatInt(shgSubmitted)}</td>
                <td>${formatInt(shgSanctioned)}</td>
                <td>${formatInt(indTarget)}</td>
                <td>${formatInt(indSubmitted)}</td>
                <td>${formatInt(indSanctioned)}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Create summary cards
        const shgCardsContainer = document.getElementById('shg-summary-cards');
        shgCardsContainer.appendChild(createSummaryCard('Target', shgTarget, shgTarget, 'shg'));
        shgCardsContainer.appendChild(createSummaryCard('Submitted', shgSubmittedTotal, shgTarget, 'shg'));
        shgCardsContainer.appendChild(createSummaryCard('Sanctioned', shgSanctionedTotal, shgTarget, 'shg'));
        shgCardsContainer.appendChild(createSummaryCard('Amount Sanctioned', shgSanctionedAmtTotal, shgTargetAmt, 'shg'));
        
        const indCardsContainer = document.getElementById('individual-summary-cards');
        indCardsContainer.appendChild(createSummaryCard('Target', indTarget, indTarget, 'individual'));
        indCardsContainer.appendChild(createSummaryCard('Submitted', indSubmittedTotal, indTarget, 'individual'));
        indCardsContainer.appendChild(createSummaryCard('Sanctioned', indSanctionedTotal, indTarget, 'individual'));
        indCardsContainer.appendChild(createSummaryCard('Amount Sanctioned', indSanctionedAmtTotal, indTargetAmt, 'individual'));
        
        // Create line chart for the block details
        createBlockDetailChart('blockDetailChart', 
            shgSubmittedData, shgSanctionedData,
            indSubmittedData, indSanctionedData,
            labels);
    }

    // Function to create block detail chart with line graphs
    function createBlockDetailChart(canvasId, 
        shgSubmittedData, shgSanctionedData,
        indSubmittedData, indSanctionedData,
        labels) {
        
        const ctx = document.getElementById(canvasId).getContext('2d');
        
        // Destroy previous chart if exists
        if (window[`${canvasId}Chart`]) {
            window[`${canvasId}Chart`].destroy();
        }
        
        window[`${canvasId}Chart`] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'SHG Submitted',
                        data: shgSubmittedData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'SHG Sanctioned',
                        data: shgSanctionedData,
                        borderColor: '#2c3e50',
                        backgroundColor: 'rgba(44, 62, 80, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Individual Submitted',
                        data: indSubmittedData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Individual Sanctioned',
                        data: indSanctionedData,
                        borderColor: '#c0392b',
                        backgroundColor: 'rgba(192, 57, 43, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatInt(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Loans',
                            padding: {top: 10, bottom: 10}
                        },
                        grid: {
                            drawBorder: false,
                            color: 'rg(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatInt(value);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Day of August 2025',
                            padding: {top: 10}
                        }
                    }
                }
            }
        });
    }

    fetch(csvUrl)
        .then(res => res.text())
        .then(text => {
            window.csvData = parseCSV(text); // Store CSV data globally for block details
            const rows = window.csvData;
            const districtData = {};
            const blockData = {};
            
            // Initialize daily data for charts (for August only)
            const dailyShgSubmitted = Array(31).fill(0);
            const dailyShgSanctioned = Array(31).fill(0);
            const dailyIndividualSubmitted = Array(31).fill(0);
            const dailyIndividualSanctioned = Array(31).fill(0);
            
            rows.slice(1).forEach(row => {
                const district = (row[0] || "").trim().toUpperCase();
                const block = (row[1] || "").trim() || "—";
                
                if (!district) return;
                
                // Initialize district data if not exists
                if (!districtData[district]) {
                    districtData[district] = {
                        shg: { submittedCount: 0, submittedAmt: 0, sanctionedCount: 0, sanctionedAmt: 0 },
                        individual: { submittedCount: 0, submittedAmt: 0, sanctionedCount: 0, sanctionedAmt: 0 }
                    };
                    blockData[district] = {};
                }
                
                // Initialize block data if not exists
                if (!blockData[district][block]) {
                    blockData[district][block] = {
                        shg: { submittedCount: 0, submittedAmt: 0, sanctionedCount: 0, sanctionedAmt: 0 },
                        individual: { submittedCount: 0, submittedAmt: 0, sanctionedCount: 0, sanctionedAmt: 0 }
                    };
                }
                
                // Process each day's data for August only (1-31)
                dayColumns.slice(0, 31).forEach((day, index) => {
                    const shgSubmittedCount = parseFloat(row[day.shgSubmittedCount]) || 0;
                    const shgSubmittedAmt = parseFloat(row[day.shgSubmittedAmt]) || 0;
                    const shgSanctionedCount = parseFloat(row[day.shgSanctionedCount]) || 0;
                    const shgSanctionedAmt = parseFloat(row[day.shgSanctionedAmt]) || 0;
                    
                    const individualSubmittedCount = parseFloat(row[day.individualSubmittedCount]) || 0;
                    const individualSubmittedAmt = parseFloat(row[day.individualSubmittedAmt]) || 0;
                    const individualSanctionedCount = parseFloat(row[day.individualSanctionedCount]) || 0;
                    const individualSanctionedAmt = parseFloat(row[day.individualSanctionedAmt]) || 0;
                    
                    // Accumulate district totals
                    districtData[district].shg.submittedCount += shgSubmittedCount;
                    districtData[district].shg.submittedAmt += shgSubmittedAmt;
                    districtData[district].shg.sanctionedCount += shgSanctionedCount;
                    districtData[district].shg.sanctionedAmt += shgSanctionedAmt;
                    
                    districtData[district].individual.submittedCount += individualSubmittedCount;
                    districtData[district].individual.submittedAmt += individualSubmittedAmt;
                    districtData[district].individual.sanctionedCount += individualSanctionedCount;
                    districtData[district].individual.sanctionedAmt += individualSanctionedAmt;
                    
                    // Accumulate block totals
                    blockData[district][block].shg.submittedCount += shgSubmittedCount;
                    blockData[district][block].shg.submittedAmt += shgSubmittedAmt;
                    blockData[district][block].shg.sanctionedCount += shgSanctionedCount;
                    blockData[district][block].shg.sanctionedAmt += shgSanctionedAmt;
                    
                    blockData[district][block].individual.submittedCount += individualSubmittedCount;
                    blockData[district][block].individual.submittedAmt += individualSubmittedAmt;
                    blockData[district][block].individual.sanctionedCount += individualSanctionedCount;
                    blockData[district][block].individual.sanctionedAmt += individualSanctionedAmt;
                    
                    // Accumulate daily totals for charts
                    dailyShgSubmitted[index] += shgSubmittedCount;
                    dailyShgSanctioned[index] += shgSanctionedCount;
                    dailyIndividualSubmitted[index] += individualSubmittedCount;
                    dailyIndividualSanctioned[index] += individualSanctionedCount;
                });
            });
            
            // Calculate totals
            let shgTotalTarget = 0, shgTotalSubmitted = 0, shgTotalSanctioned = 0, shgTotalAmtSubmitted = 0, shgTotalAmtSanctioned = 0;
            let individualTotalTarget = 0, individualTotalSubmitted = 0, individualTotalSanctioned = 0, individualTotalAmtSubmitted = 0, individualTotalAmtSanctioned = 0;
            
            Object.keys(districtData).forEach(district => {
                shgTotalTarget += targets[district]?.shg.loan || 0;
                shgTotalSubmitted += districtData[district].shg.submittedCount;
                shgTotalSanctioned += districtData[district].shg.sanctionedCount;
                shgTotalAmtSubmitted += districtData[district].shg.submittedAmt;
                shgTotalAmtSanctioned += districtData[district].shg.sanctionedAmt;
                
                individualTotalTarget += targets[district]?.individual.loan || 0;
                individualTotalSubmitted += districtData[district].individual.submittedCount;
                individualTotalSanctioned += districtData[district].individual.sanctionedCount;
                individualTotalAmtSubmitted += districtData[district].individual.submittedAmt;
                individualTotalAmtSanctioned += districtData[district].individual.sanctionedAmt;
            });
            
            const shgAchievement = shgTotalTarget ? (shgTotalSanctioned / shgTotalTarget) * 100 : 0;
            const individualAchievement = individualTotalTarget ? (individualTotalSanctioned / individualTotalTarget) * 100 : 0;
            const shgApprovalRate = shgTotalSubmitted ? (shgTotalSanctioned / shgTotalSubmitted) * 100 : 0;
            const individualApprovalRate = individualTotalSubmitted ? (individualTotalSanctioned / individualTotalSubmitted) * 100 : 0;
            
            // Remove loading animations before updating content
            removeLoadingAnimations();
            
            // Animate the numbers counting up
            animateCountUp(document.getElementById('shg-target-value'), shgTotalTarget);
            animateCountUp(document.getElementById('shg-submitted-value'), shgTotalSubmitted);
            animateCountUp(document.getElementById('shg-sanctioned-value'), shgTotalSanctioned);
            animateCountUp(document.getElementById('shg-approval-value'), shgApprovalRate, 1500, true);
            animateCountUp(document.getElementById('shg-achievement-value'), shgAchievement, 1500, true);
            
            animateCountUp(document.getElementById('individual-target-value'), individualTotalTarget);
            animateCountUp(document.getElementById('individual-submitted-value'), individualTotalSubmitted);
            animateCountUp(document.getElementById('individual-sanctioned-value'), individualTotalSanctioned);
            animateCountUp(document.getElementById('individual-approval-value'), individualApprovalRate, 1500, true);
            animateCountUp(document.getElementById('individual-achievement-value'), individualAchievement, 1500, true);
            
            // Animate progress circles
            animateProgressCircle('shg-progress-circle', shgAchievement);
            animateProgressCircle('individual-progress-circle', individualAchievement);
            
            // Create charts with only data up to current date
            createCharts(
                dailyShgSubmitted.slice(0, daysToShow),
                dailyShgSanctioned.slice(0, daysToShow),
                dailyIndividualSubmitted.slice(0, daysToShow),
                dailyIndividualSanctioned.slice(0, daysToShow)
            );
            
            const tbody = document.querySelector("#loanTable tbody");
            const districtOrder = [
                "DHALAI", "GOMATI", "KHOWAI", "SOUTH TRIPURA", 
                "NORTH TRIPURA", "SEPAHIJALA", "UNAKOTI", "WEST TRIPURA"
            ];
            
            // Calculate the last 3 days range
            const currentDay = daysToShow;
            const last3DaysStart = Math.max(1, currentDay - 2);
            const last3DaysEnd = currentDay;
            
            // Function to compute last 3 days progress for a specific row
            function computeLast3DaysProgress(row, district, block = null) {
                let result = {
                    shgSubmitted: 0,
                    shgSanctioned: 0,
                    individualSubmitted: 0,
                    individualSanctioned: 0
                };
                
                // If row is provided, use it directly
                if (row) {
                    for (let day = last3DaysStart; day <= last3DaysEnd; day++) {
                        const dayData = dayColumns[day - 1];
                        if (!dayData) continue;
                        
                        result.shgSubmitted += parseFloat(row[dayData.shgSubmittedCount]) || 0;
                        result.shgSanctioned += parseFloat(row[dayData.shgSanctionedCount]) || 0;
                        result.individualSubmitted += parseFloat(row[dayData.individualSubmittedCount]) || 0;
                        result.individualSanctioned += parseFloat(row[dayData.individualSanctionedCount]) || 0;
                    }
                    return result;
                }
                
                // If row is not provided, find it in CSV data
                for (let i = 1; i < window.csvData.length; i++) {
                    const csvRow = window.csvData[i];
                    const rowDistrict = (csvRow[0] || "").trim().toUpperCase();
                    const rowBlock = (csvRow[1] || "").trim();
                    
                    if (rowDistrict === district && (block === null || rowBlock === block)) {
                        for (let day = last3DaysStart; day <= last3DaysEnd; day++) {
                            const dayData = dayColumns[day - 1];
                            if (!dayData) continue;
                            
                            result.shgSubmitted += parseFloat(csvRow[dayData.shgSubmittedCount]) || 0;
                            result.shgSanctioned += parseFloat(csvRow[dayData.shgSanctionedCount]) || 0;
                            result.individualSubmitted += parseFloat(csvRow[dayData.individualSubmittedCount]) || 0;
                            result.individualSanctioned += parseFloat(csvRow[dayData.individualSanctionedCount]) || 0;
                        }
                    }
                }
                
                return result;
            }
            
            districtOrder.forEach(district => {
                if (!districtData[district]) {
                    console.warn(`District ${district} not found in data`);
                    return;
                }
                
                const d = districtData[district];
                const shgTarget = targets[district]?.shg.loan ?? 0;
                const shgTargetAmt = targets[district]?.shg.amount ?? 0;
                const individualTarget = targets[district]?.individual.loan ?? 0;
                const individualTargetAmt = targets[district]?.individual.amount ?? 0;
                
                const shgAch = shgTarget ? (d.shg.sanctionedCount / shgTarget) * 100 : 0;
                const individualAch = individualTarget ? (d.individual.sanctionedCount / individualTarget) * 100 : 0;
                
                // Get last 3 days progress for district
                const last3Days = computeLast3DaysProgress(null, district);
                
                const tr = document.createElement("tr");
                tr.className = "district-row";
                tr.dataset.district = district;
                
                // Create cells with conditional last 3 days display
                tr.innerHTML = `
                    <td>${district}</td>
                    <td>${formatInt(shgTarget)}</td>
                    <td class="amount-cell">₹${formatAmt(shgTargetAmt)}</td>
                    <td>
                        <div>${formatInt(d.shg.submittedCount)}</div>
                        ${last3Days.shgSubmitted > 0 ? 
                            `<div class="last3-days">(+${formatInt(last3Days.shgSubmitted)} last 3 days)</div>` : ''}
                    </td>
                    <td class="amount-cell">₹${formatAmt(d.shg.submittedAmt)}</td>
                    <td>
                        <div>${formatInt(d.shg.sanctionedCount)}</div>
                        ${last3Days.shgSanctioned > 0 ? 
                            `<div class="last3-days">(+${formatInt(last3Days.shgSanctioned)} last 3 days)</div>` : ''}
                    </td>
                    <td class="amount-cell">₹${formatAmt(d.shg.sanctionedAmt)}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress progress-thin">
                                <div class="progress-bar ${getProgressBarClass(shgAch)}" role="progressbar" style="width: ${Math.min(shgAch, 100)}%"></div>
                            </div>
                            <div class="text-center mt-1"><small>${Math.round(shgAch)}%</small></div>
                        </div>
                    </td>
                    <td>${formatInt(individualTarget)}</td>
                    <td class="amount-cell">₹${formatAmt(individualTargetAmt)}</td>
                    <td>
                        <div>${formatInt(d.individual.submittedCount)}</div>
                        ${last3Days.individualSubmitted > 0 ? 
                            `<div class="last3-days">(+${formatInt(last3Days.individualSubmitted)} last 3 days)</div>` : ''}
                    </td>
                    <td class="amount-cell">₹${formatAmt(d.individual.submittedAmt)}</td>
                    <td>
                        <div>${formatInt(d.individual.sanctionedCount)}</div>
                        ${last3Days.individualSanctioned > 0 ? 
                            `<div class="last3-days">(+${formatInt(last3Days.individualSanctioned)} last 3 days)</div>` : ''}
                    </td>
                    <td class="amount-cell">₹${formatAmt(d.individual.sanctionedAmt)}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress progress-thin">
                                <div class="progress-bar ${getProgressBarClass(individualAch)}" role="progressbar" style="width: ${Math.min(individualAch, 100)}%"></div>
                            </div>
                            <div class="text-center mt-1"><small>${Math.round(individualAch)}%</small></div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
                tr.addEventListener("click", () => toggleBlocks(tr, district, blockData[district], last3DaysStart, last3DaysEnd));
            });
            
            const trSummary = document.createElement("tr");
            trSummary.className = "summary-row";
            trSummary.innerHTML = `
                <td><strong>Total</strong></td>
                <td><strong>${formatInt(shgTotalTarget)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(shgTotalTarget * 3.13)}</strong></td>
                <td><strong>${formatInt(shgTotalSubmitted)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(shgTotalAmtSubmitted)}</strong></td>
                <td><strong>${formatInt(shgTotalSanctioned)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(shgTotalAmtSanctioned)}</strong></td>
                <td>
                    <div class="progress-container">
                        <div class="progress progress-thin">
                            <div class="progress-bar ${getProgressBarClass(shgAchievement)}" role="progressbar" style="width: ${Math.min(shgAchievement, 100)}%"></div>
                        </div>
                        <div class="text-center mt-1"><small><strong>${Math.round(shgAchievement)}%</strong></small></div>
                    </div>
                </td>
                <td><strong>${formatInt(individualTotalTarget)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(individualTotalTarget * 2)}</strong></td>
                <td><strong>${formatInt(individualTotalSubmitted)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(individualTotalAmtSubmitted)}</strong></td>
                <td><strong>${formatInt(individualTotalSanctioned)}</strong></td>
                <td class="amount-cell"><strong>₹${formatAmt(individualTotalAmtSanctioned)}</strong></td>
                <td>
                    <div class="progress-container">
                        <div class="progress progress-thin">
                            <div class="progress-bar ${getProgressBarClass(individualAchievement)}" role="progressbar" style="width: ${Math.min(individualAchievement, 100)}%"></div>
                        </div>
                        <div class="text-center mt-1"><small><strong>${Math.round(individualAchievement)}%</strong></small></div>
                    </div>
                </td>
            `;
            tbody.appendChild(trSummary);
            
            // Add event listener for the toggle all button
            document.getElementById('toggleAll').addEventListener('click', toggleAllBlocks);
        })
        .catch(error => {
            console.error("Error loading data:", error);
            removeLoadingAnimations();
            document.querySelectorAll('.stat-value').forEach(el => {
                el.textContent = "Error";
            });
        });

    function createCharts(shgSubmitted, shgSanctioned, individualSubmitted, individualSanctioned) {
        // Create labels for days (1-current date August)
        const dayLabels = Array.from({length: daysToShow}, (_, i) => `${i+1} Aug`);
        
        // Register the plugin to all charts
        Chart.register(ChartDataLabels);
        
        // SHG Loan Chart
        const shgCtx = document.getElementById('shgLoanChart').getContext('2d');
        new Chart(shgCtx, {
            type: 'bar',
            data: {
                labels: dayLabels,
                datasets: [
                    {
                        label: 'Submitted',
                        data: shgSubmitted,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    },
                    {
                        label: 'Sanctioned',
                        data: shgSanctioned,
                        backgroundColor: 'rgba(26, 82, 118, 0.9)',
                        borderColor: 'rgba(26, 82, 118, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatInt(value);
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Loans',
                            padding: {top: 10, bottom: 10}
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Day of August 2025',
                            padding: {top: 10}
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatInt(context.raw)}`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: function(value) {
                            return formatInt(value);
                        },
                        color: '#34495e',
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
        
        // Individual Loan Chart
        const individualCtx = document.getElementById('individualLoanChart').getContext('2d');
        new Chart(individualCtx, {
            type: 'bar',
            data: {
                labels: dayLabels,
                datasets: [
                    {
                        label: 'Submitted',
                        data: individualSubmitted,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    },
                    {
                        label: 'Sanctioned',
                        data: individualSanctioned,
                        backgroundColor: 'rgba(150, 40, 27, 0.9)',
                        borderColor: 'rgba(150, 40, 27, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatInt(value);
                            }
                        },
                        title: {
                            display: true,
                            text: 'Number of Loans',
                            padding: {top: 10, bottom: 10}
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: 'Day of August 2025',
                            padding: {top: 10}
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatInt(context.raw)}`;
                            }
                        }
                    },
                    datalabels: {
                        anchor: 'end',
                        align: 'top',
                        formatter: function(value) {
                            return formatInt(value);
                        },
                        color: '#34495e',
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function animateProgressCircle(id, percentage) {
        const circle = document.getElementById(id);
        const radius = 14;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percentage / 100) * circumference;
        
        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = circumference;
        
        setTimeout(() => {
            circle.style.strokeDashoffset = offset;
        }, 100);
    }

    function sumCols(row, cols) {
        return cols.reduce((sum, idx) => sum + (parseFloat(row[idx]) || 0), 0);
    }

    function getProgressBarClass(value) {
        if (value >= 80) return "bg-success";
        if (value >= 50) return "bg-warning";
        return "bg-danger";
    }

    function formatInt(n) {
        return (n||0).toLocaleString("en-IN");
    }

    function formatAmt(n) {
        return (n||0).toLocaleString("en-IN", { maximumFractionDigits: 1 });
    }

    function toggleBlocks(districtRow, districtName, blocksObj, last3DaysStart, last3DaysEnd) {
        const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
        
        if (existing.length) {
            existing.forEach(el => el.remove());
            return;
        }
        
        let last = districtRow;
        
        Object.keys(blocksObj).forEach(block => {
            const b = blocksObj[block];
            const blockTarget = blockTargets[block] || { shg: { loan: 0, amount: 0 }, individual: { loan: 0, amount: 0 } };
            
            const shgAch = blockTarget.shg.loan ? (b.shg.sanctionedCount / blockTarget.shg.loan) * 100 : 0;
            const individualAch = blockTarget.individual.loan ? (b.individual.sanctionedCount / blockTarget.individual.loan) * 100 : 0;
            
            // Find the CSV row for this block to get last 3 days progress
            let last3Days = {
                shgSubmitted: 0,
                shgSanctioned: 0,
                individualSubmitted: 0,
                individualSanctioned: 0
            };
            
            // Find the CSV row for this block
            const csvRow = window.csvData.find(row => 
                row[0].trim().toUpperCase() === districtName && 
                row[1].trim().toUpperCase() === block.toUpperCase()
            );
            
            if (csvRow) {
                for (let day = last3DaysStart; day <= last3DaysEnd; day++) {
                    const dayData = dayColumns[day - 1];
                    if (!dayData) continue;
                    
                    last3Days.shgSubmitted += parseFloat(csvRow[dayData.shgSubmittedCount]) || 0;
                    last3Days.shgSanctioned += parseFloat(csvRow[dayData.shgSanctionedCount]) || 0;
                    last3Days.individualSubmitted += parseFloat(csvRow[dayData.individualSubmittedCount]) || 0;
                    last3Days.individualSanctioned += parseFloat(csvRow[dayData.individualSanctionedCount]) || 0;
                }
            }
            
            const trb = document.createElement("tr");
            trb.className = "block-row";
            trb.dataset.parent = districtName;
            
            // Create cells with conditional last 3 days display
            trb.innerHTML = `
                <td>
                    ${block} 
                    <i class="bi bi-info-circle info-icon" 
                       onclick="showBlockDetails('${districtName}', '${block}')"
                       title="View block details"></i>
                </td>
                <td>${formatInt(blockTarget.shg.loan)}</td>
                <td class="amount-cell">₹${formatAmt(blockTarget.shg.amount)}</td>
                <td>
                    <div>${formatInt(b.shg.submittedCount)}</div>
                    ${last3Days.shgSubmitted > 0 ? 
                        `<div class="last3-days">(+${formatInt(last3Days.shgSubmitted)} last 3 days)</div>` : ''}
                </td>
                <td class="amount-cell">₹${formatAmt(b.shg.submittedAmt)}</td>
                <td>
                    <div>${formatInt(b.shg.sanctionedCount)}</div>
                    ${last3Days.shgSanctioned > 0 ? 
                        `<div class="last3-days">(+${formatInt(last3Days.shgSanctioned)} last 3 days)</div>` : ''}
                </td>
                <td class="amount-cell">₹${formatAmt(b.shg.sanctionedAmt)}</td>
                <td>
                    <div class="progress-container">
                        <div class="progress progress-thin">
                            <div class="progress-bar ${getProgressBarClass(shgAch)}" role="progressbar" style="width: ${Math.min(shgAch, 100)}%"></div>
                        </div>
                        <div class="text-center mt-1"><small>${Math.round(shgAch)}%</small></div>
                    </div>
                </td>
                <td>${formatInt(blockTarget.individual.loan)}</td>
                <td class="amount-cell">₹${formatAmt(blockTarget.individual.amount)}</td>
                <td>
                    <div>${formatInt(b.individual.submittedCount)}</div>
                    ${last3Days.individualSubmitted > 0 ? 
                        `<div class="last3-days">(+${formatInt(last3Days.individualSubmitted)} last 3 days)</div>` : ''}
                </td>
                <td class="amount-cell">₹${formatAmt(b.individual.submittedAmt)}</td>
                <td>
                    <div>${formatInt(b.individual.sanctionedCount)}</div>
                    ${last3Days.individualSanctioned > 0 ? 
                        `<div class="last3-days">(+${formatInt(last3Days.individualSanctioned)} last 3 days)</div>` : ''}
                </td>
                <td class="amount-cell">₹${formatAmt(b.individual.sanctionedAmt)}</td>
                <td>
                    <div class="progress-container">
                        <div class="progress progress-thin">
                            <div class="progress-bar ${getProgressBarClass(individualAch)}" role="progressbar" style="width: ${Math.min(individualAch, 100)}%"></div>
                        </div>
                        <div class="text-center mt-1"><small>${Math.round(individualAch)}%</small></div>
                    </div>
                </td>
            `;
            
            last.insertAdjacentElement("afterend", trb);
            last = trb;
        });
    }

    function toggleAllBlocks() {
        const button = document.getElementById('toggleAll');
        const isExpanded = button.textContent.includes('Collapse');
        
        if (isExpanded) {
            // Collapse all
            document.querySelectorAll('.district-row').forEach(row => {
                const districtName = row.dataset.district;
                const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
                if (existing.length) {
                    existing.forEach(el => el.remove());
                }
            });
            button.innerHTML = '<i class="bi bi-arrows-angle-expand"></i> Expand All Districts';
        } else {
            // Expand all
            document.querySelectorAll('.district-row').forEach(row => {
                const districtName = row.dataset.district;
                const existing = document.querySelectorAll(`tr.block-row[data-parent="${districtName}"]`);
                if (!existing.length) {
                    row.click(); // Trigger the click to expand
                }
            });
            button.innerHTML = '<i class="bi bi-arrows-angle-contract"></i> Collapse All Districts';
        }
    }

    function parseCSV(text) {
        const rows = [];
        let row = [];
        let cur = "";
        let inQuotes = false;
        
        for (let i = 0; i < text.length; i++) {
            const c = text[i];
            
            if (c === '"') {
                if (inQuotes && text[i+1] === '"') {
                    cur += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (c === ',' && !inQuotes) {
                row.push(cur);
                cur = "";
            } else if ((c === '\n' || c === '\r') && !inQuotes) {
                if (cur.length || row.length) {
                    row.push(cur);
                    rows.push(row);
                    row = [];
                    cur = "";
                }
                if (c === '\r' && text[i+1] === '\n') i++;
            } else {
                cur += c;
            }
        }
        
        if (cur.length || row.length) {
            row.push(cur);
            rows.push(row);
        }
        
        return rows;
    }

    // Expose showBlockDetails to global scope for onclick events
    window.showBlockDetails = showBlockDetails;

    // Font size control for table
    document.addEventListener('DOMContentLoaded', function() {
        const table = document.getElementById('loanTable');
        const decreaseBtn = document.getElementById('decrease-font');
        const resetBtn = document.getElementById('reset-font');
        const increaseBtn = document.getElementById('increase-font');
        
        // Initialize font size class
        if (!localStorage.getItem('tableFontSize')) {
            localStorage.setItem('tableFontSize', 'font-md');
        }
        
        table.classList.add(localStorage.getItem('tableFontSize'));
        
        decreaseBtn.addEventListener('click', function() {
            changeFontSize('decrease');
        });
        
        resetBtn.addEventListener('click', function() {
            changeFontSize('reset');
        });
        
        increaseBtn.addEventListener('click', function() {
            changeFontSize('increase');
        });
        
        function changeFontSize(action) {
            const currentSize = localStorage.getItem('tableFontSize');
            let newSize;
            
            if (action === 'decrease') {
                if (currentSize === 'font-lg') newSize = 'font-md';
                else if (currentSize === 'font-md') newSize = 'font-sm';
                else if (currentSize === 'font-xl') newSize = 'font-lg';
                else newSize = 'font-sm';
            } 
            else if (action === 'increase') {
                if (currentSize === 'font-sm') newSize = 'font-md';
                else if (currentSize === 'font-md') newSize = 'font-lg';
                else if (currentSize === 'font-lg') newSize = 'font-xl';
                else newSize = 'font-xl';
            }
            else { // reset
                newSize = 'font-md';
            }
            
            // Remove all font classes
            table.classList.remove('font-sm', 'font-md', 'font-lg', 'font-xl');
            // Add new font class
            table.classList.add(newSize);
            // Store preference
            localStorage.setItem('tableFontSize', newSize);
        }
    });
    </script>
</body>
</html>
