<!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Loan Target & Submission Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        h2 {
            color: #34495e;
            text-align: center;
            margin: 30px 0 15px 0;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
            overflow-x: auto;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
        }
        th {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 14px 8px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid #2980b9;
        }
        th:last-child {
            border-right: none;
        }
        td {
            border: 1px solid #ddd;
            padding: 10px 8px;
            text-align: right;
            min-width: 120px;
        }
        td:first-child {
            text-align: left;
            font-weight: bold;
            background-color: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 5;
            min-width: 180px;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e3f2fd;
        }
        .section-header {
            background-color: #e8f4fc !important;
            font-weight: bold;
            color: #2c3e50;
        }
        .total-row {
            background-color: #2c3e50 !important;
            color: white;
            font-weight: bold;
        }
        .total-row td {
            border-color: #2c3e50;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 18px;
        }
        .error {
            background-color: #ffe6e6;
            color: #c0392b;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin: 20px auto;
            max-width: 600px;
            border: 1px solid #c0392b;
        }
        .note {
            text-align: center;
            color: #7f8c8d;
            font-size: 12px;
            margin-top: 10px;
            font-style: italic;
        }
        .summary-box {
            background: white;
            padding: 15px;
            margin: 20px auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        @media print {
            body {
                background-color: white;
            }
            table {
                box-shadow: none;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body>
    <h1>Comprehensive District-wise Loan Target & Submission Report</h1>
    <div class="summary-box no-print">
        <p>Data loaded from Google Sheets</p>
        <p>Report generated on: <span id="currentDate"></span></p>
    </div>
    <div class="container">
        <div id="output" class="loading">Loading and processing data from Google Sheet...</div>
    </div>

    <script>
        async function loadAndProcessCSV() {
            try {
                // Google Sheet CSV export URL
                const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKZv2oeWp8NIvfF8RX1gmUi710FpEPs-2BAhUaxq4Tr6HvY02XcoyMuO77cmFtre_u81u7dyg0tzJI/pub?output=csv';
                
                // Fetch CSV data
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                
                // Parse CSV
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                
                if (rows.length === 0) {
                    throw new Error('No data found in CSV');
                }
                
                // Get headers
                const headers = rows[0].split(',').map(h => h.trim());
                
                // Find column indices for all required columns
                const columnIndices = {
                    // District column
                    district: findColumnIndex(headers, ['district', 'dist']),
                    
                    // SHG Loan Target
                    shgTargetCount: findColumnIndex(headers, ['no. of shg loan target', 'shg loan target count', 'number of shg loan target']),
                    shgTargetAmount: findColumnIndex(headers, ['amt of shg loan target', 'shg loan target amount', 'amount of shg loan target']),
                    
                    // SHG Loan Submitted upto 17 Nov 2025
                    shgSubmittedCountNov: findColumnIndex(headers, ['no. of shg loan submitted upto 17 nov 2025', 'shg loan submitted count nov', 'shg submitted upto 17 nov']),
                    shgSubmittedAmountNov: findColumnIndex(headers, ['amt of shg loan submitted upto 17 nov 2025', 'shg loan submitted amount nov', 'shg amount upto 17 nov']),
                    
                    // SHG Loan Submitted for Dec 2025
                    shgSubmittedCountDec: findColumnIndex(headers, ['sub total of shg loan submitted from 1-31 dec 2025', 'shg loan submitted count dec', 'shg submitted dec 2025']),
                    shgSubmittedAmountDec: findColumnIndex(headers, ['sub total amt of shg loan submitted from 1-31 dec 2025', 'shg loan submitted amount dec', 'shg amount dec 2025']),
                    
                    // Individual Loan Target
                    individualTargetCount: findColumnIndex(headers, ['no. of individual loan target', 'individual loan target count', 'number of individual loan target']),
                    individualTargetAmount: findColumnIndex(headers, ['amt of individual loan target', 'individual loan target amount', 'amount of individual loan target']),
                    
                    // Individual Loan Submitted upto 17 Nov 2025
                    individualSubmittedCountNov: findColumnIndex(headers, ['no. of individual loan submitted upto 17 nov 2025', 'individual loan submitted count nov', 'individual submitted upto 17 nov']),
                    individualSubmittedAmountNov: findColumnIndex(headers, ['amt of individual loan submitted upto 17 nov 2025', 'individual loan submitted amount nov', 'individual amount upto 17 nov']),
                    
                    // Individual Loan Submitted for Dec 2025
                    individualSubmittedCountDec: findColumnIndex(headers, ['sub total of individual loan submitted from 1-31 dec 2025', 'individual loan submitted count dec', 'individual submitted dec 2025']),
                    individualSubmittedAmountDec: findColumnIndex(headers, ['sub total amt of individual loan submitted from 1-31 dec 2025', 'individual loan submitted amount dec', 'individual amount dec 2025'])
                };
                
                // Validate that all required columns were found
                const missingColumns = Object.entries(columnIndices)
                    .filter(([key, value]) => value === -1)
                    .map(([key]) => key);
                
                if (missingColumns.length > 0) {
                    console.warn('Missing columns:', missingColumns);
                }
                
                // Initialize aggregation object
                const districtData = {};
                
                // Process each data row
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].split(',');
                    const district = cells[columnIndices.district]?.trim();
                    
                    if (!district || district === '') continue;
                    
                    // Initialize district if not exists
                    if (!districtData[district]) {
                        districtData[district] = {
                            // SHG Totals
                            shgTargetCount: 0,
                            shgTargetAmount: 0,
                            shgSubmittedCountNov: 0,
                            shgSubmittedAmountNov: 0,
                            shgSubmittedCountDec: 0,
                            shgSubmittedAmountDec: 0,
                            
                            // Individual Totals
                            individualTargetCount: 0,
                            individualTargetAmount: 0,
                            individualSubmittedCountNov: 0,
                            individualSubmittedAmountNov: 0,
                            individualSubmittedCountDec: 0,
                            individualSubmittedAmountDec: 0
                        };
                    }
                    
                    // Aggregate SHG data
                    aggregateData(districtData[district], 'shgTargetCount', cells[columnIndices.shgTargetCount]);
                    aggregateData(districtData[district], 'shgTargetAmount', cells[columnIndices.shgTargetAmount]);
                    aggregateData(districtData[district], 'shgSubmittedCountNov', cells[columnIndices.shgSubmittedCountNov]);
                    aggregateData(districtData[district], 'shgSubmittedAmountNov', cells[columnIndices.shgSubmittedAmountNov]);
                    aggregateData(districtData[district], 'shgSubmittedCountDec', cells[columnIndices.shgSubmittedCountDec]);
                    aggregateData(districtData[district], 'shgSubmittedAmountDec', cells[columnIndices.shgSubmittedAmountDec]);
                    
                    // Aggregate Individual data
                    aggregateData(districtData[district], 'individualTargetCount', cells[columnIndices.individualTargetCount]);
                    aggregateData(districtData[district], 'individualTargetAmount', cells[columnIndices.individualTargetAmount]);
                    aggregateData(districtData[district], 'individualSubmittedCountNov', cells[columnIndices.individualSubmittedCountNov]);
                    aggregateData(districtData[district], 'individualSubmittedAmountNov', cells[columnIndices.individualSubmittedAmountNov]);
                    aggregateData(districtData[district], 'individualSubmittedCountDec', cells[columnIndices.individualSubmittedCountDec]);
                    aggregateData(districtData[district], 'individualSubmittedAmountDec', cells[columnIndices.individualSubmittedAmountDec]);
                }
                
                // Convert to array and sort districts
                const districts = Object.keys(districtData);
                districts.sort();
                
                // Calculate grand totals
                const grandTotals = {
                    shgTargetCount: 0,
                    shgTargetAmount: 0,
                    shgSubmittedCountNov: 0,
                    shgSubmittedAmountNov: 0,
                    shgSubmittedCountDec: 0,
                    shgSubmittedAmountDec: 0,
                    individualTargetCount: 0,
                    individualTargetAmount: 0,
                    individualSubmittedCountNov: 0,
                    individualSubmittedAmountNov: 0,
                    individualSubmittedCountDec: 0,
                    individualSubmittedAmountDec: 0
                };
                
                // Create HTML table
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>District</th>
                                <th colspan="6" class="section-header">SHG Loans</th>
                                <th colspan="6" class="section-header">Individual Loans</th>
                            </tr>
                            <tr>
                                <th></th>
                                <!-- SHG Sub-headers -->
                                <th>No. of Target</th>
                                <th>Amt of Target (₹)</th>
                                <th>No. Submitted (upto 17 Nov)</th>
                                <th>Amt Submitted (upto 17 Nov) (₹)</th>
                                <th>No. Submitted (Dec 2025)</th>
                                <th>Amt Submitted (Dec 2025) (₹)</th>
                                <!-- Individual Sub-headers -->
                                <th>No. of Target</th>
                                <th>Amt of Target (₹)</th>
                                <th>No. Submitted (upto 17 Nov)</th>
                                <th>Amt Submitted (upto 17 Nov) (₹)</th>
                                <th>No. Submitted (Dec 2025)</th>
                                <th>Amt Submitted (Dec 2025) (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add district rows
                districts.forEach(district => {
                    const data = districtData[district];
                    
                    html += `<tr>`;
                    html += `<td>${district}</td>`;
                    
                    // SHG data
                    html += `<td>${formatNumber(data.shgTargetCount)}</td>`;
                    html += `<td>${formatCurrency(data.shgTargetAmount)}</td>`;
                    html += `<td>${formatNumber(data.shgSubmittedCountNov)}</td>`;
                    html += `<td>${formatCurrency(data.shgSubmittedAmountNov)}</td>`;
                    html += `<td>${formatNumber(data.shgSubmittedCountDec)}</td>`;
                    html += `<td>${formatCurrency(data.shgSubmittedAmountDec)}</td>`;
                    
                    // Individual data
                    html += `<td>${formatNumber(data.individualTargetCount)}</td>`;
                    html += `<td>${formatCurrency(data.individualTargetAmount)}</td>`;
                    html += `<td>${formatNumber(data.individualSubmittedCountNov)}</td>`;
                    html += `<td>${formatCurrency(data.individualSubmittedAmountNov)}</td>`;
                    html += `<td>${formatNumber(data.individualSubmittedCountDec)}</td>`;
                    html += `<td>${formatCurrency(data.individualSubmittedAmountDec)}</td>`;
                    
                    html += `</tr>`;
                    
                    // Update grand totals
                    Object.keys(grandTotals).forEach(key => {
                        grandTotals[key] += data[key];
                    });
                });
                
                // Add grand totals row
                html += `
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td><strong>GRAND TOTAL</strong></td>
                                <!-- SHG grand totals -->
                                <td><strong>${formatNumber(grandTotals.shgTargetCount)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.shgTargetAmount)}</strong></td>
                                <td><strong>${formatNumber(grandTotals.shgSubmittedCountNov)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.shgSubmittedAmountNov)}</strong></td>
                                <td><strong>${formatNumber(grandTotals.shgSubmittedCountDec)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.shgSubmittedAmountDec)}</strong></td>
                                <!-- Individual grand totals -->
                                <td><strong>${formatNumber(grandTotals.individualTargetCount)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.individualTargetAmount)}</strong></td>
                                <td><strong>${formatNumber(grandTotals.individualSubmittedCountNov)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.individualSubmittedAmountNov)}</strong></td>
                                <td><strong>${formatNumber(grandTotals.individualSubmittedCountDec)}</strong></td>
                                <td><strong>${formatCurrency(grandTotals.individualSubmittedAmountDec)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="note">
                        * All amounts are in Indian Rupees (₹)<br>
                        * Data source: Google Sheets | Last updated: ${new Date().toLocaleDateString()}
                    </div>
                `;
                
                document.getElementById('output').innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('output').innerHTML = 
                    `<div class="error">
                        <h3>Error Loading Data</h3>
                        <p>${error.message}</p>
                        <p>Please check the console for more details.</p>
                    </div>`;
            }
        }
        
        // Helper function to find column index
        function findColumnIndex(headers, possibleNames) {
            for (const name of possibleNames) {
                const index = headers.findIndex(h => 
                    h.toLowerCase().includes(name.toLowerCase())
                );
                if (index !== -1) return index;
            }
            return -1;
        }
        
        // Helper function to aggregate data
        function aggregateData(obj, key, value) {
            if (value !== undefined && value !== '') {
                const numValue = parseFloat(value) || 0;
                obj[key] += numValue;
            }
        }
        
        // Helper function to format numbers
        function formatNumber(num) {
            return Number.isInteger(num) ? num.toLocaleString() : num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // Helper function to format currency
        function formatCurrency(amount) {
            if (amount >= 10000000) {
                return `₹${(amount / 10000000).toFixed(2)} Cr`;
            } else if (amount >= 100000) {
                return `₹${(amount / 100000).toFixed(2)} L`;
            } else {
                return `₹${formatNumber(amount)}`;
            }
        }
        
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        
        // Load data when page loads
        window.addEventListener('DOMContentLoaded', loadAndProcessCSV);
        
        // Auto-refresh every 5 minutes
        setInterval(loadAndProcessCSV, 300000);
        
    </script>
</body>
</html>
